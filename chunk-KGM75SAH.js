import{a as be,b as Se}from"./chunk-2H4PJY2W.js";import{a as K}from"./chunk-NHWKIFHZ.js";import{a as $,e as G,g as fe,h as ye,i as X,j as J,k as we,l as De}from"./chunk-TOC7PNXQ.js";import{e as y,f as g,g as U,h as b,i as u,j as R,k as P,l as me,m as he,n as w,o as q,p as Y,q as T,r as ge,s as pe,u as I}from"./chunk-JNP63KUK.js";import{r as ue,t as z}from"./chunk-WQRABBEY.js";import{Ac as O,P as k,U as L,a as S,b as x,ja as c,r as de}from"./chunk-XTNRL3Y3.js";var V=class l{dashboardRepo=L(be);authService=L($);stats=c(null);isLoading=c(!1);error=c(null);async loadDashboardStats(){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=await this.dashboardRepo.getWorkspacesByUserId(t),s=e.map(p=>p.id);if(s.length===0){let p={domainsExpiring7Days:0,domainsExpiring15Days:0,domainsExpiring30Days:0,domainsExpiring60Days:0,subscriptionsExpiring7Days:0,subscriptionsExpiring15Days:0,subscriptionsExpiring30Days:0,subscriptionsExpiring60Days:0,totalWorkspaces:0,activeWorkspaces:0,workspacesInError:[],totalDomains:0,totalSubscriptions:0};return this.stats.set(p),p}let r=await this.dashboardRepo.getDomainsByWorkspaceIds(s),o=await this.dashboardRepo.getSubscriptionsByWorkspaceIds(s),n=new Date,a=new Date(n.getTime()+10080*60*1e3),i=new Date(n.getTime()+360*60*60*1e3),h=new Date(n.getTime()+720*60*60*1e3),d=new Date(n.getTime()+1440*60*60*1e3),D=r.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=a&&m>n}).length,A=r.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=i&&m>n}).length,j=r.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=h&&m>n}).length,W=r.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=d&&m>n}).length,C=o.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=a&&m>n}).length,N=o.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=i&&m>n}).length,E=o.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=h&&m>n}).length,v=o.filter(p=>{let m=this.toDate(p.expiresAt);return m&&m<=d&&m>n}).length,H=e.filter(p=>p.status==="ACTIVE").length,ce=e.filter(p=>p.status!=="ACTIVE"),Q={domainsExpiring7Days:D,domainsExpiring15Days:A,domainsExpiring30Days:j,domainsExpiring60Days:W,subscriptionsExpiring7Days:C,subscriptionsExpiring15Days:N,subscriptionsExpiring30Days:E,subscriptionsExpiring60Days:v,totalWorkspaces:e.length,activeWorkspaces:H,workspacesInError:ce,totalDomains:r.length,totalSubscriptions:o.length};return this.stats.set(Q),Q}catch(t){let e=t instanceof Error?t.message:"Failed to load dashboard stats";throw this.error.set(e),console.error("Error loading dashboard stats:",t),t}finally{this.isLoading.set(!1)}}toDate(t){return t?t instanceof Date?t:typeof t=="object"&&t!==null&&"seconds"in t&&"nanoseconds"in t?new Date(t.seconds*1e3):typeof t=="object"&&t!==null&&"seconds"in t?new Date(t.seconds*1e3):null:null}clearError(){this.error.set(null)}getExpirationTrends(){let t=this.stats();return t?[{label:"7 d\xEDas",domains:t.domainsExpiring7Days,subscriptions:t.subscriptionsExpiring7Days},{label:"15 d\xEDas",domains:t.domainsExpiring15Days,subscriptions:t.subscriptionsExpiring15Days},{label:"30 d\xEDas",domains:t.domainsExpiring30Days,subscriptions:t.subscriptionsExpiring30Days},{label:"60 d\xEDas",domains:t.domainsExpiring60Days,subscriptions:t.subscriptionsExpiring60Days}]:[]}async getUpcomingEvents(t=10){try{let e=this.authService.getCurrentUserUid();if(!e)return[];let s=await this.dashboardRepo.getWorkspacesByUserId(e),r=s.map(d=>d.id);if(r.length===0)return[];let o=new Map(s.map(d=>[d.id,d.name])),n=await this.dashboardRepo.getDomainsByWorkspaceIds(r),a=await this.dashboardRepo.getSubscriptionsByWorkspaceIds(r),i=new Date,h=[];return n.forEach(d=>{let D=this.toDate(d.expiresAt);if(!D||D<=i)return;let A=Math.ceil((D.getTime()-i.getTime())/(1e3*60*60*24));h.push({id:d.id,title:d.domainName,type:"domain",expirationDate:D,workspaceName:o.get(d.workspaceId)||"Unknown",daysUntilExpiration:A,status:A<=7?"critical":A<=15?"warning":"info"})}),a.forEach(d=>{let D=this.toDate(d.expiresAt);if(!D||D<=i)return;let A=Math.ceil((D.getTime()-i.getTime())/(1e3*60*60*24));h.push({id:d.id,title:d.productName,type:"subscription",expirationDate:D,workspaceName:o.get(d.workspaceId)||"Unknown",daysUntilExpiration:A,status:A<=7?"critical":A<=15?"warning":"info"})}),h.sort((d,D)=>d.daysUntilExpiration-D.daysUntilExpiration).slice(0,t)}catch(e){return console.error("Error getting upcoming events:",e),[]}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var Z=class l{firestore=I.getFirestore();isLoading=c(!1);error=c(null);async getDomains(t){try{this.isLoading.set(!0),this.error.set(null);let e=[u("workspaceId","==",t.workspaceId)];if(t.daysToExpire!==void 0){let h=new Date;h.setDate(h.getDate()+t.daysToExpire),e.push(u("expiresAt","<=",h))}e.push(R("expiresAt","asc"));let s=t.pageSize||20;e.push(P(s+1)),t.lastDoc&&e.push(me(t.lastDoc));let r=b(g(this.firestore,"domains"),...e),o=await w(r),n=o.docs.map(h=>x(S({},h.data()),{id:h.id}));if(t.searchText){let h=t.searchText.toLowerCase();n=n.filter(d=>d.domainName?.toLowerCase().includes(h))}let a=n.length>s;a&&(n=n.slice(0,s));let i=n.length>0?o.docs[n.length-1]:null;return{domains:n,lastDoc:i,hasMore:a}}catch(e){let s=e instanceof Error?e.message:"Error desconocido";throw this.error.set(s),console.error("Error fetching domains:",e),e}finally{this.isLoading.set(!1)}}async getAllDomains(t){try{this.isLoading.set(!0),this.error.set(null);let e=b(g(this.firestore,"domains"),u("workspaceId","==",t),R("expiresAt","asc"));return(await w(e)).docs.map(o=>x(S({},o.data()),{id:o.id}))}catch(e){let s=e instanceof Error?e.message:"Error desconocido";throw this.error.set(s),console.error("[DomainService] Error fetching all domains:",e),e instanceof Error&&e.message.includes("index")&&console.error("[DomainService] \u26A0\uFE0F Firestore index required. Check Firebase Console."),e}finally{this.isLoading.set(!1)}}getDaysUntilExpiration(t){let e=this.toDate(t);if(!e)return null;let s=new Date,r=e.getTime()-s.getTime();return Math.ceil(r/(1e3*60*60*24))}getExpirationStatus(t){let e=this.getDaysUntilExpiration(t);return e===null?"ok":e<0?"expired":e<=7?"critical":e<=30?"warning":"ok"}toDate(t){return t?t instanceof Date?t:typeof t=="object"&&"toDate"in t?t.toDate():typeof t=="object"&&"seconds"in t?new Date(t.seconds*1e3):null:null}clearError(){this.error.set(null)}async getDomainById(t){try{this.isLoading.set(!0),this.error.set(null);let e=U(this.firestore,"domains",t),s=await he(e);return s.exists()?x(S({},s.data()),{id:s.id}):null}catch(e){let s=e instanceof Error?e.message:"Failed to fetch domain";throw this.error.set(s),e}finally{this.isLoading.set(!1)}}async updateDomain(t,e){try{this.isLoading.set(!0),this.error.set(null);let s=U(this.firestore,"domains",t);await q(s,e)}catch(s){let r=s instanceof Error?s.message:"Failed to update domain";throw this.error.set(r),s}finally{this.isLoading.set(!1)}}async getDomainStatistics(t){let e=await this.getAllDomains(t),s={total:e.length,expired:0,critical:0,warning:0,active:0,totalValue:0};return e.forEach(r=>{switch(this.getExpirationStatus(r.expiresAt)){case"expired":s.expired++;break;case"critical":s.critical++;break;case"warning":s.warning++;break;case"ok":s.active++;break}let n=Number(r.renewalPrice)||(Number(r.hostingRenewalPrice)||0)+(Number(r.domainRenewalPrice)||0);s.totalValue+=n}),s}async getDomainsGroupedByMonth(t){let e=await this.getAllDomains(t),s=new Map;return e.forEach(r=>{let o=this.toDate(r.expiresAt);if(!o)return;let n=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`;s.has(n)||s.set(n,[]),s.get(n).push(r)}),Array.from(s.entries()).map(([r,o])=>({month:r,count:o.length,domains:o})).sort((r,o)=>r.month.localeCompare(o.month))}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var _=class l{firestore=I.getFirestore();functions=I.getFunctions();workspaceContext=L(K);http=L(z);dnsRecords=c([]);snapshots=c([]);validationResults=c(null);isLoading=c(!1);isSyncing=c(!1);error=c(null);filteredRecords=c([]);selectedDomain=c(null);selectedRecordTypes=c([]);async validateDns(t){this.isLoading.set(!0),this.error.set(null);let e=this.workspaceContext.workspaceId();if(!e){let s="No workspace selected";throw this.error.set(s),this.isLoading.set(!1),new Error(s)}try{let o=(await pe(this.functions,"validateDns")({workspaceId:e,domainName:t})).data,n=o?.validatedAt;if(n&&typeof n.toDate!="function")if(typeof n.seconds=="number"){let a=n.seconds*1e3+(n.nanoseconds?Math.round(n.nanoseconds/1e6):0);o.validatedAt=y.fromMillis(a)}else typeof n=="string"||typeof n=="number"?o.validatedAt=y.fromDate(new Date(n)):o.validatedAt=y.now();return this.validationResults.set(o),o}catch(s){console.error("Error validating DNS:",s);let r="Failed to validate DNS";throw s instanceof Error&&(r=s.message),this.error.set(r),s}finally{this.isLoading.set(!1)}}async getDnsRecordsByDomain(t){this.isLoading.set(!0),this.error.set(null),this.selectedDomain.set(t);try{let e=this.workspaceContext.workspaceId();if(!e)throw new Error("No workspace selected");let s=g(this.firestore,"dnsRecords"),r=b(s,u("workspaceId","==",e),u("domainName","==",t)),n=(await w(r)).docs.map(a=>{let i=a.data();return new ye({id:a.id,workspaceId:i.workspaceId,domainName:i.domainName,recordType:i.recordType,name:i.name,value:i.value,ttl:i.ttl,priority:i.priority,syncedAt:i.syncedAt})});return this.dnsRecords.set(n),this.filteredRecords.set(n),n}catch(e){throw e instanceof Error?this.error.set(e.message):this.error.set("Unknown error fetching DNS records"),e}finally{this.isLoading.set(!1)}}filterByRecordTypes(t){if(this.selectedRecordTypes.set(t),t.length===0){this.filteredRecords.set(this.dnsRecords());return}let e=this.dnsRecords().filter(s=>t.includes(s.recordType));this.filteredRecords.set(e)}clearFilters(){this.selectedRecordTypes.set([]),this.filteredRecords.set(this.dnsRecords())}async getSnapshotsByDomain(t){this.isLoading.set(!0),this.error.set(null);try{let e=this.workspaceContext.workspaceId();if(!e)throw new Error("No workspace selected");let s=g(this.firestore,"dnsSnapshots"),r=b(s,u("workspaceId","==",e),u("domainName","==",t)),n=(await w(r)).docs.map(a=>{let i=a.data();return new X({id:a.id,workspaceId:i.workspaceId,domainName:i.domainName,records:i.records||[],createdAt:i.createdAt,note:i.note})});return n.sort((a,i)=>i.createdAt.toMillis()-a.createdAt.toMillis()),this.snapshots.set(n),n}catch(e){throw e instanceof Error?this.error.set(e.message):this.error.set("Unknown error fetching DNS snapshots"),e}finally{this.isLoading.set(!1)}}async createSnapshot(t,e){this.isLoading.set(!0),this.error.set(null);try{let s=this.workspaceContext.workspaceId();if(!s)throw new Error("No workspace selected");let r=this.dnsRecords();if(r.length===0)throw new Error("No DNS records to snapshot. Sync DNS records first.");let o=[];for(let d of r)o.push({id:d.id,workspaceId:d.workspaceId,domainName:d.domainName,recordType:d.recordType,name:d.name,value:d.value,ttl:d.ttl,priority:d.priority??null,syncedAt:d.syncedAt});let n=g(this.firestore,"dnsSnapshots"),a=await T(n,{workspaceId:s,domainName:t,records:o,createdAt:y.now(),note:e||void 0}),i=new X({id:a.id,workspaceId:s,domainName:t,records:r,createdAt:y.now(),note:e}),h=[i,...this.snapshots()];return this.snapshots.set(h),i}catch(s){throw s instanceof Error?this.error.set(s.message):this.error.set("Unknown error creating DNS snapshot"),s}finally{this.isLoading.set(!1)}}compareWithSnapshot(t){let e=this.snapshots().find(r=>r.id===t);if(!e)return this.error.set("Snapshot not found"),null;let s=this.dnsRecords();return e.compareWith(s)}getRecordCountByType(){let t=new Map,e=this.filteredRecords();for(let s of e){let r=t.get(s.recordType)||0;t.set(s.recordType,r+1)}return t}clearState(){this.dnsRecords.set([]),this.snapshots.set([]),this.filteredRecords.set([]),this.selectedDomain.set(null),this.selectedRecordTypes.set([]),this.error.set(null)}async syncDnsRecords(t){this.isSyncing.set(!0),this.error.set(null);try{let s=await de(this.http.post("https://syncdnsrecordshttp-7jxe2gomqa-uc.a.run.app",{workspaceId:t})),r=this.selectedDomain();return r&&await this.getDnsRecordsByDomain(r),s}catch(e){throw e instanceof Error?this.error.set(e.message):this.error.set("Unknown error syncing DNS records"),e}finally{this.isSyncing.set(!1)}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var ee=class l{alertRepo=L(Se);alerts=c([]);isLoading=c(!1);error=c(null);async getAlertsByWorkspace(t,e){this.isLoading.set(!0),this.error.set(null);try{let s=await this.alertRepo.getAlertsByWorkspace(t,e);return this.alerts.set(s),s}catch(s){let r=s instanceof Error?s.message:"Error al cargar alertas";throw this.error.set(r),console.error("Error fetching alerts:",s),s}finally{this.isLoading.set(!1)}}async getAlertsByEntity(t,e,s){this.isLoading.set(!0),this.error.set(null);try{return await this.alertRepo.getAlertsByEntity(t,e,s)}catch(r){let o=r instanceof Error?r.message:"Error al cargar alertas de entidad";throw this.error.set(o),console.error("Error fetching entity alerts:",r),r}finally{this.isLoading.set(!1)}}async getCriticalAlerts(t){this.isLoading.set(!0),this.error.set(null);try{return await this.alertRepo.getCriticalAlerts(t,7)}catch(e){let s=e instanceof Error?e.message:"Error al cargar alertas cr\xEDticas";throw this.error.set(s),console.error("Error fetching critical alerts:",e),e}finally{this.isLoading.set(!1)}}async getAlertStats(t){let e=await this.getAlertsByWorkspace(t);return{totalAlerts:e.length,criticalAlerts:e.filter(r=>r.isCritical()).length,warningAlerts:e.filter(r=>r.isWarning()).length,infoAlerts:e.filter(r=>r.isInfo()).length,byEntityType:{domains:e.filter(r=>r.entityType==="domain").length,subscriptions:e.filter(r=>r.entityType==="subscription").length}}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var te=class l{firestore=I.getFirestore();auditLogs=c([]);isLoading=c(!1);error=c(null);async getAuditLogs(t){this.isLoading.set(!0),this.error.set(null);try{let e=g(this.firestore,"audit_logs"),s=[R("createdAt","desc")];t?.workspaceId&&s.push(u("workspaceId","==",t.workspaceId)),t?.actorUid&&s.push(u("actorUid","==",t.actorUid)),t?.action&&s.push(u("action","==",t.action)),t?.status&&s.push(u("status","==",t.status)),t?.startDate&&s.push(u("createdAt",">=",y.fromDate(t.startDate))),t?.endDate&&s.push(u("createdAt","<=",y.fromDate(t.endDate))),t?.limitCount&&s.push(P(t.limitCount));let r=b(e,...s),n=(await w(r)).docs.map(a=>{let i=a.data();return new fe(x(S({},i),{id:a.id}))});return this.auditLogs.set(n),n}catch(e){let s=e instanceof Error?e.message:"Error al cargar audit logs";throw this.error.set(s),console.error("Error fetching audit logs:",e),e}finally{this.isLoading.set(!1)}}async getWorkspaceAuditLogs(t,e=50){return this.getAuditLogs({workspaceId:t,limitCount:e})}async getRecentAuditLogs(t=100){let e=new Date(Date.now()-864e5);return this.getAuditLogs({startDate:e,limitCount:t})}async getFailedAuditLogs(t,e=50){return this.getAuditLogs({workspaceId:t,status:"failed",limitCount:e})}async getAuditStats(t){let e=await this.getAuditLogs({workspaceId:t,limitCount:1e3}),s={total:e.length,success:e.filter(r=>r.isSuccess()).length,failure:e.filter(r=>r.isFailure()).length,partial:e.filter(r=>r.isPartial()).length,byAction:{}};return e.forEach(r=>{s.byAction[r.action]=(s.byAction[r.action]||0)+1}),s}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var se=class l{firestore=I.getFirestore();syncRuns=c([]);isLoading=c(!1);error=c(null);async getSyncRunsByWorkspace(t,e=50){this.isLoading.set(!0),this.error.set(null);try{let s=g(this.firestore,"sync_runs"),r=b(s,u("workspaceId","==",t),R("startedAt","desc"),P(e)),n=(await w(r)).docs.map(a=>{let i=a.data();return new G(x(S({},i),{id:a.id}))});return this.syncRuns.set(n),n}catch(s){let r=s instanceof Error?s.message:"Error al cargar sync runs";throw this.error.set(r),console.error("Error fetching sync runs:",s),s}finally{this.isLoading.set(!1)}}async getRecentSyncRuns(t=100){this.isLoading.set(!0),this.error.set(null);try{let e=g(this.firestore,"sync_runs"),s=b(e,R("startedAt","desc"),P(t)),o=(await w(s)).docs.map(n=>{let a=n.data();return new G(x(S({},a),{id:n.id}))});return this.syncRuns.set(o),o}catch(e){let s=e instanceof Error?e.message:"Error al cargar sync runs";throw this.error.set(s),console.error("Error fetching sync runs:",e),e}finally{this.isLoading.set(!1)}}async getFailedSyncRuns(t,e=50){this.isLoading.set(!0),this.error.set(null);try{let s=g(this.firestore,"sync_runs"),r=[u("status","==","failed"),R("startedAt","desc"),P(e)];t&&r.unshift(u("workspaceId","==",t));let o=b(s,...r);return(await w(o)).docs.map(i=>{let h=i.data();return new G(x(S({},h),{id:i.id}))})}catch(s){let r=s instanceof Error?s.message:"Error al cargar sync runs fallidos";throw this.error.set(r),console.error("Error fetching failed sync runs:",s),s}finally{this.isLoading.set(!1)}}async getSyncStats(t){let e=await this.getSyncRunsByWorkspace(t,100);return{totalRuns:e.length,successfulRuns:e.filter(r=>r.isSuccess()).length,failedRuns:e.filter(r=>r.isFailed()).length,partialRuns:e.filter(r=>r.isPartialSuccess&&r.isPartialSuccess()).length,totalDomains:e.reduce((r,o)=>r+(o.domainsProcessed||0),0),totalSubscriptions:e.reduce((r,o)=>r+(o.subscriptionsProcessed||0),0),averageDuration:e.length>0?e.reduce((r,o)=>r+(o.getDurationMs()||0),0)/e.length:0,lastSyncDate:e.length>0?e[0].startAt.toDate():null}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var re=class l{exportToCSV(t,e,s){if(!t||t.length===0){console.warn("No data to export");return}let r=s?s.map(a=>a.label):Object.keys(t[0]),o=s?s.map(a=>a.key):Object.keys(t[0]),n=[r.join(","),...t.map(a=>o.map(i=>{let h=a[i];return this.escapeCSVValue(h)}).join(","))].join(`
`);this.downloadFile(n,e,"text/csv;charset=utf-8;")}exportToJSON(t,e){let s=JSON.stringify(t,null,2);this.downloadFile(s,e,"application/json")}escapeCSVValue(t){if(t==null)return"";let e;return t instanceof Date?e=t.toISOString():typeof t=="object"?e=JSON.stringify(t):e=String(t),e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e}downloadFile(t,e,s){let r=new Blob([t],{type:s}),o=window.URL.createObjectURL(r),n=document.createElement("a");n.href=o,n.download=e,n.click(),window.URL.revokeObjectURL(o)}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var ne=class l{firestore;constructor(){this.firestore=I.getFirestore()}workspaceMetrics=c([]);systemSummary=c(null);isLoading=c(!1);error=c(null);healthyWorkspaces=O(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="healthy"));criticalWorkspaces=O(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="critical"));warningWorkspaces=O(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="warning"));workspacesNearLimit=O(()=>this.workspaceMetrics().filter(t=>t.isNearRateLimit()));async getAllHealthMetrics(){this.isLoading.set(!0),this.error.set(null);try{let t=g(this.firestore,"workspaces"),s=(await w(t)).docs.map(async o=>{let n=o.data();return this.calculateWorkspaceMetrics(o.id,n.name||"Unknown")}),r=await Promise.all(s);return this.workspaceMetrics.set(r),r}catch(t){let e=t instanceof Error?t.message:"Error fetching health metrics";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}async getWorkspaceHealth(t,e){return this.calculateWorkspaceMetrics(t,e)}async calculateWorkspaceMetrics(t,e){let s=new Date;s.setDate(s.getDate()-30);let r=g(this.firestore,"sync_runs"),o=b(r,u("workspaceId","==",t),u("startedAt",">=",y.fromDate(s)),R("startedAt","desc")),n;try{n=await w(o)}catch(f){console.error("[HealthService] Query failed:",f);let M=b(r,u("workspaceId","==",t));n=await w(M)}let a=n.docs.map(f=>{let M=f.data();return S({id:f.id},M)});if(a.length===0){console.warn(`[HealthService] No syncRuns found for workspace ${t}. Checking if any syncRuns exist at all...`);let f=await w(g(this.firestore,"sync_runs"));if(console.warn(`[HealthService] Total syncRuns in database: ${f.docs.length}`),f.docs.length>0){let M=f.docs[0];console.warn("[HealthService] Sample document from syncRuns collection:",{id:M.id,data:M.data()})}}let i=a.length,h=a.filter(f=>f.status==="success").length,d=i-h,D=0;for(let f of a)if(f.status==="failed")D++;else break;let A=a.filter(f=>f.status==="success"&&f.duration),j=A.length>0?A.reduce((f,M)=>f+(M.duration||0),0)/A.length:0,W=a.find(f=>f.status==="success"),C=a.find(f=>f.status==="failed"),N=new Date;N.setHours(N.getHours()-24);let E=a.filter(f=>{let B=f.startedAt?.toDate?.();return B&&B>=N&&f.status==="failed"&&f.errorMessage}),v={};E.forEach(f=>{let M=f.errorMessage||"Unknown error",B=this.categorizeError(M);v[B]=(v[B]||0)+1});let H=C?.errorMessage||null,Q=C?.startedAt?.toDate?.()||null,p=E.length,m=D>=5?"open":"closed",ke=m==="open"&&C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,le=J.calculateHealthScore({rateLimitPercentage:0,consecutiveFailures:D,errorFrequency:p,circuitBreakerStatus:m}),Ee=J.getHealthStatusFromScore(le),ve={workspaceId:t,workspaceName:e,rateLimitRequests:0,rateLimitRemaining:0,rateLimitResetTime:null,rateLimitPercentage:0,lastSuccessfulSync:W?.startedAt&&typeof W.startedAt?.toDate=="function"?W.startedAt.toDate():null,lastFailedSync:C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,consecutiveFailures:D,averageSyncTime:j,totalSyncs:i,successfulSyncs:h,failedSyncs:d,lastError:H,lastErrorTime:Q,errorFrequency:p,errorTypes:v,circuitBreakerStatus:m,circuitBreakerOpenedAt:ke,healthStatus:Ee,healthScore:le,lastUpdated:new Date};return new J(ve)}categorizeError(t){let e=t.toLowerCase();return e.includes("rate limit")||e.includes("too many requests")?"Rate Limit":e.includes("auth")||e.includes("unauthorized")||e.includes("401")?"Authentication":e.includes("network")||e.includes("timeout")||e.includes("econnrefused")?"Network":e.includes("not found")||e.includes("404")?"Not Found":e.includes("server error")||e.includes("500")?"Server Error":"Other"}async getSystemHealthSummary(){let t=await this.getAllHealthMetrics(),e=t.length,s=t.filter(E=>E.healthStatus==="healthy").length,r=t.filter(E=>E.healthStatus==="warning").length,o=t.filter(E=>E.healthStatus==="critical").length,n=0,a=0,i=new Date;i.setHours(0,0,0,0);let h=t.reduce((E,v)=>{let H=v.lastSuccessfulSync&&v.lastSuccessfulSync>=i?1:0;return E+H},0),d=t.reduce((E,v)=>{let H=v.lastSuccessfulSync&&v.lastSuccessfulSync>=i&&(!v.lastFailedSync||v.lastSuccessfulSync>v.lastFailedSync)?1:0;return E+H},0),D=h-d,A=t.reduce((E,v)=>E+v.errorFrequency,0),j=t.filter(E=>E.errorFrequency>0).length,W=e>0?t.reduce((E,v)=>E+v.healthScore,0)/e:100,C={totalWorkspaces:e,healthyWorkspaces:s,warningWorkspaces:r,criticalWorkspaces:o,totalRateLimitUsage:n,workspacesNearLimit:a,totalSyncsToday:h,successfulSyncsToday:d,failedSyncsToday:D,totalErrors24h:A,workspacesWithErrors:j,averageHealthScore:W,lastUpdated:new Date},N=new we(C);return this.systemSummary.set(N),N}async refresh(){await Promise.all([this.getAllHealthMetrics(),this.getSystemHealthSummary()])}async saveHealthHistory(t){try{let e=g(this.firestore,"healthHistory"),s=[];for(let r of t){let o=w(b(e,u("workspaceId","==",r.workspaceId))).then(()=>Promise.resolve());s.push(o)}await Promise.all(s)}catch(e){throw console.error("[HealthService] Error saving health history:",e),e}}async getWorkspaceHistory(t,e=7){try{let s=g(this.firestore,"healthHistory"),r=new Date;r.setDate(r.getDate()-e);let o=b(s,u("workspaceId","==",t),u("timestamp",">=",y.fromDate(r)),R("timestamp","desc"));return(await w(o)).docs.map(a=>{let i=a.data();return new De({timestamp:i.timestamp.toDate(),workspaceId:i.workspaceId,healthScore:i.healthScore,rateLimitUsage:i.rateLimitUsage,syncSuccess:i.syncSuccessRate>80,errorCount:i.errorCount})})}catch(s){return console.error("[HealthService] Error fetching health history:",s),[]}}async detectAndCreateAlerts(){let t=this.workspaceMetrics(),e=0;for(let s of t)s.hasConsecutiveFailures()&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Sync Failures Detected",`${s.consecutiveFailures} consecutive sync failures. Check workspace configuration.`),e++),s.isCircuitOpen()&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Circuit Breaker Open","Circuit breaker has been triggered. Workspace syncs are paused."),e++),s.healthScore<50&&s.healthStatus==="critical"&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Critical Health Status",`Health score is ${s.healthScore}/100. Multiple issues detected.`),e++);return e}async createHealthAlert(t,e,s,r,o){try{let n=g(this.firestore,"healthAlerts"),a=new Date;a.setHours(a.getHours()-1);let i=b(n,u("workspaceId","==",t),u("title","==",r),u("createdAt",">=",y.fromDate(a)));if((await w(i)).size>0)return;let d={workspaceId:t,workspaceName:e,severity:s,title:r,message:o,isRead:!1,createdAt:y.fromDate(new Date)};await T(n,d)}catch(n){console.error("[HealthService] Error creating health alert:",n)}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var oe=class l{firestore=I.getFirestore();emailConfigs=c([]);emailLogs=c([]);isLoading=c(!1);error=c(null);async getEmailConfig(t){try{let e=g(this.firestore,"emailConfigs"),s=b(e,u("workspaceId","==",t)),r=await w(s);if(r.empty)return null;let o=r.docs[0];return S({id:o.id},o.data())}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to get email config: ${s}`),e}}async createEmailConfig(t){try{let e=g(this.firestore,"emailConfigs");if(await this.getEmailConfig(t.workspaceId))throw new Error("Email configuration already exists for this workspace");return(await T(e,x(S({},t),{createdAt:y.now()}))).id}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to create email config: ${s}`),e}}async updateEmailConfig(t,e){try{let s=await this.getEmailConfig(t);if(!s?.id)throw new Error("Email configuration not found");let r=U(this.firestore,"emailConfigs",s.id);await q(r,x(S({},e),{updatedAt:y.now()}))}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to update email config: ${r}`),s}}async deleteEmailConfig(t){try{let e=await this.getEmailConfig(t);if(!e?.id)throw new Error("Email configuration not found");let s=U(this.firestore,"emailConfigs",e.id);await Y(s)}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to delete email config: ${s}`),e}}async getEmailLogs(t,e=50){try{this.isLoading.set(!0);let s=g(this.firestore,"emailLogs"),r=b(s,u("workspaceId","==",t),R("createdAt","desc")),n=(await w(r)).docs.slice(0,e).map(a=>S({id:a.id},a.data()));return this.emailLogs.set(n),n}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to get email logs: ${r}`),s}finally{this.isLoading.set(!1)}}async createEmailLog(t){try{let e=g(this.firestore,"emailLogs");return(await T(e,x(S({},t),{createdAt:y.now()}))).id}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to create email log: ${s}`),e}}async updateEmailLog(t,e){try{let s=U(this.firestore,"emailLogs",t);await q(s,x(S({},e),{updatedAt:y.now()}))}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to update email log: ${r}`),s}}async getPendingEmails(){try{let t=g(this.firestore,"emailLogs"),e=y.now(),s=b(t,u("status","in",["pending","retrying"]),u("nextRetryAt","<=",e),R("nextRetryAt","asc"));return(await w(s)).docs.map(o=>S({id:o.id},o.data()))}catch(t){let e=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to get pending emails: ${e}`),t}}async getEmailStats(t){try{let e=await this.getEmailLogs(t,1e3);return{total:e.length,sent:e.filter(s=>s.status==="sent").length,failed:e.filter(s=>s.status==="failed").length,pending:e.filter(s=>s.status==="pending").length,retrying:e.filter(s=>s.status==="retrying").length}}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to get email stats: ${s}`),e}}async isEmailEnabled(t){try{return(await this.getEmailConfig(t))?.enabled??!1}catch{return!1}}async checkRateLimits(t){try{let e=await this.getEmailConfig(t);if(!e)return{canSend:!1,hourlyCount:0,dailyCount:0,maxPerHour:0,maxPerDay:0};let s=e.rateLimit?.maxPerHour??10,r=e.rateLimit?.maxPerDay??50,o=new Date;o.setHours(o.getHours()-1);let n=new Date;n.setDate(n.getDate()-1);let a=await this.getEmailLogs(t,1e3),i=a.filter(D=>D.sentAt?D.sentAt.toDate()>=o:!1).length,h=a.filter(D=>D.sentAt?D.sentAt.toDate()>=n:!1).length;return{canSend:i<s&&h<r,hourlyCount:i,dailyCount:h,maxPerHour:s,maxPerDay:r}}catch(e){let s=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to check rate limits: ${s}`),e}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var ae=class l{firestore=I.getFirestore();authService=L($);dashboardService=L(V);snapshots=c([]);isLoading=c(!1);error=c(null);async createSnapshot(){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=await this.dashboardService.loadDashboardStats(),s={userId:t,snapshotAt:ge(),totalWorkspaces:e.totalWorkspaces,activeWorkspaces:e.activeWorkspaces,totalDomains:e.totalDomains,totalSubscriptions:e.totalSubscriptions,domainsExpiring7Days:e.domainsExpiring7Days,domainsExpiring15Days:e.domainsExpiring15Days,domainsExpiring30Days:e.domainsExpiring30Days,domainsExpiring60Days:e.domainsExpiring60Days,subscriptionsExpiring7Days:e.subscriptionsExpiring7Days,subscriptionsExpiring15Days:e.subscriptionsExpiring15Days,subscriptionsExpiring30Days:e.subscriptionsExpiring30Days,subscriptionsExpiring60Days:e.subscriptionsExpiring60Days,workspacesInError:e.workspacesInError.length},r=await T(g(this.firestore,"dashboardSnapshots"),s);return await this.loadSnapshots(),r.id}catch(t){let e=t instanceof Error?t.message:"Failed to create snapshot";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}async loadSnapshots(t=30){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let s=b(g(this.firestore,"dashboardSnapshots"),u("userId","==",e),R("snapshotAt","desc"),P(t)),o=(await w(s)).docs.map(n=>S({id:n.id},n.data()));return this.snapshots.set(o),o}catch(e){let s=e instanceof Error?e.message:"Failed to load snapshots";throw this.error.set(s),e}finally{this.isLoading.set(!1)}}getComparisonData(t=this.snapshots()){let e=[...t].sort((s,r)=>{let o=s.snapshotAt instanceof y?s.snapshotAt.toDate():s.snapshotAt,n=r.snapshotAt instanceof y?r.snapshotAt.toDate():r.snapshotAt;return o.getTime()-n.getTime()});return{labels:e.map(s=>(s.snapshotAt instanceof y?s.snapshotAt.toDate():s.snapshotAt).toLocaleDateString("es-ES",{month:"short",day:"numeric"})),workspaces:e.map(s=>s.totalWorkspaces),domains:e.map(s=>s.totalDomains),subscriptions:e.map(s=>s.totalSubscriptions)}}getChangeMetrics(t,e){return{workspaceChange:t.totalWorkspaces-e.totalWorkspaces,domainChange:t.totalDomains-e.totalDomains,subscriptionChange:t.totalSubscriptions-e.totalSubscriptions,expiringDomainsChange:t.domainsExpiring7Days-e.domainsExpiring7Days}}async deleteOldSnapshots(t=90){try{let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let s=new Date;s.setDate(s.getDate()-t);let r=b(g(this.firestore,"dashboardSnapshots"),u("userId","==",e),u("snapshotAt","<",y.fromDate(s))),n=(await w(r)).docs.map(a=>Y(a.ref));await Promise.all(n),await this.loadSnapshots()}catch(e){let s=e instanceof Error?e.message:"Failed to delete old snapshots";throw this.error.set(s),e}}getLatestSnapshot(){let t=this.snapshots();return t.length===0?null:t[0]}getSnapshotDaysAgo(t){let e=new Date;return e.setDate(e.getDate()-t),this.snapshots().find(s=>(s.snapshotAt instanceof y?s.snapshotAt.toDate():s.snapshotAt).toDateString()===e.toDateString())||null}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};var ie=class l{http=L(z);isSending=c(!1);lastError=c(null);async sendWebhook(t,e){if(t.enabled&&t.events.includes(e.event)&&!(t.minSeverity==="critical"&&e.severity==="warning")){this.isSending.set(!0),this.lastError.set(null);try{let s=this.formatPayload(t.platform,e),r=this.buildHeaders(t);await this.http.post(t.url,s,{headers:r}).toPromise()}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.lastError.set(r),console.error("Failed to send webhook",{error:s,url:t.url}),s}finally{this.isSending.set(!1)}}}async sendTestWebhook(t){if(!t.enableTestNotifications)throw new Error("Test notifications are disabled for this webhook");let e={event:"health.warning",severity:"warning",title:"Test Notification",message:"This is a test notification from Hostinger Workspace Manager",workspace:{id:"test-workspace",name:"Test Workspace"},timestamp:new Date().toISOString(),metadata:{healthScore:75}};await this.sendWebhook(t,e)}formatPayload(t,e){switch(t){case"slack":return this.formatSlackPayload(e);case"discord":return this.formatDiscordPayload(e);case"teams":return this.formatTeamsPayload(e);default:return e}}formatSlackPayload(t){let e=t.severity==="critical"?"danger":"warning",s=t.severity==="critical"?":rotating_light:":":warning:",r=[{title:"Workspace",value:t.workspace.name,short:!0},{title:"Severity",value:t.severity.toUpperCase(),short:!0}];return t.metadata&&(t.metadata.healthScore!==void 0&&r.push({title:"Health Score",value:`${t.metadata.healthScore}/100`,short:!0}),t.metadata.rateLimitPercentage!==void 0&&r.push({title:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`,short:!0}),t.metadata.consecutiveFailures!==void 0&&r.push({title:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString(),short:!0})),{text:`${s} ${t.title}`,attachments:[{color:e,title:t.title,text:t.message,fields:r,footer:"Hostinger Workspace Manager",ts:Math.floor(new Date(t.timestamp).getTime()/1e3)}]}}formatDiscordPayload(t){let e=t.severity==="critical"?16711680:16753920,s=[{name:"Workspace",value:t.workspace.name,inline:!0},{name:"Severity",value:t.severity.toUpperCase(),inline:!0}];return t.metadata&&(t.metadata.healthScore!==void 0&&s.push({name:"Health Score",value:`${t.metadata.healthScore}/100`,inline:!0}),t.metadata.rateLimitPercentage!==void 0&&s.push({name:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`,inline:!0}),t.metadata.consecutiveFailures!==void 0&&s.push({name:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString(),inline:!0})),{embeds:[{title:t.title,description:t.message,color:e,fields:s,footer:{text:"Hostinger Workspace Manager"},timestamp:t.timestamp}]}}formatTeamsPayload(t){let e=t.severity==="critical"?"FF0000":"FFA500",s=[{name:"Workspace",value:t.workspace.name},{name:"Severity",value:t.severity.toUpperCase()}];return t.metadata&&(t.metadata.healthScore!==void 0&&s.push({name:"Health Score",value:`${t.metadata.healthScore}/100`}),t.metadata.rateLimitPercentage!==void 0&&s.push({name:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`}),t.metadata.consecutiveFailures!==void 0&&s.push({name:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString()})),{"@type":"MessageCard","@context":"https://schema.org/extensions",themeColor:e,summary:t.title,sections:[{activityTitle:t.title,activitySubtitle:t.message,facts:s}]}}buildHeaders(t){let e=new ue({"Content-Type":"application/json"});return t.headers&&Object.entries(t.headers).forEach(([s,r])=>{e=e.set(s,r)}),t.secret&&(e=e.set("X-Webhook-Secret",t.secret)),e}mapAlertToWebhookEvent(t,e){return t.includes("Rate Limit Critical")?"rateLimit.critical":t.includes("Rate Limit Warning")?"rateLimit.warning":t.includes("Consecutive Failures")||t.includes("Sync Failures")?"sync.consecutiveFailures":t.includes("Circuit Breaker")?"circuitBreaker.open":t.includes("Sync Failed")?"sync.failure":e==="critical"?"health.critical":"health.warning"}static \u0275fac=function(e){return new(e||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};export{V as a,Z as b,_ as c,ee as d,te as e,se as f,re as g,ne as h,oe as i};

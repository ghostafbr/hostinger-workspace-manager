import{a as bt,b as it,c as ot,d as Wt}from"./chunk-A446VFIH.js";import{a as q}from"./chunk-4WCFDIDM.js";import{a as Ot}from"./chunk-SEX3EHUL.js";import{Ba as nt,Ha as _,Ia as u,Ja as ft,Ka as h,La as c,Ma as E,Na as B,Qa as f,Ra as yt,Sa as st,Ta as rt,Ua as U,Wa as k,Xa as at,Ya as ct,a as Pt,c as Nt,cb as T,e as jt,h as et,xa as Ut,ya as R,za as Vt}from"./chunk-MQX4I6TC.js";import{Cb as dt,Db as ut,Ec as ht,Fb as Q,Jb as K,Ka as kt,Kb as v,Lb as Ct,Mb as Ft,Nb as Tt,O as b,Oa as A,P as H,Pb as mt,Qb as gt,R as $,T as I,Ub as Lt,Xb as Z,Y as L,Yb as C,Z as M,Zb as Mt,_ as Et,_b as Rt,a as y,ab as X,b as x,bb as J,da as pt,eb as G,ec as tt,fb as Y,gb as N,ia as d,mb as j,oa as W,qc as Bt,vb as D,wb as O,xb as z,yb as At}from"./chunk-ZVXIGZDY.js";var zt=`
    .p-skeleton {
        display: block;
        overflow: hidden;
        background: dt('skeleton.background');
        border-radius: dt('skeleton.border.radius');
    }

    .p-skeleton::after {
        content: '';
        animation: p-skeleton-animation 1.2s infinite;
        height: 100%;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transform: translateX(-100%);
        z-index: 1;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0), dt('skeleton.animation.background'), rgba(255, 255, 255, 0));
    }

    [dir='rtl'] .p-skeleton::after {
        animation-name: p-skeleton-animation-rtl;
    }

    .p-skeleton-circle {
        border-radius: 50%;
    }

    .p-skeleton-animation-none::after {
        animation: none;
    }

    @keyframes p-skeleton-animation {
        from {
            transform: translateX(-100%);
        }
        to {
            transform: translateX(100%);
        }
    }

    @keyframes p-skeleton-animation-rtl {
        from {
            transform: translateX(100%);
        }
        to {
            transform: translateX(-100%);
        }
    }
`;var re={root:{position:"relative"}},ie={root:({instance:r})=>["p-skeleton p-component",{"p-skeleton-circle":r.shape==="circle","p-skeleton-animation-none":r.animation==="none"}]},qt=(()=>{class r extends nt{name="skeleton";style=zt;classes=ie;inlineStyles=re;static \u0275fac=(()=>{let t;return function(s){return(t||(t=W(r)))(s||r)}})();static \u0275prov=b({token:r,factory:r.\u0275fac})}return r})();var Qt=new $("SKELETON_INSTANCE"),oe=(()=>{class r extends ct{$pcSkeleton=I(Qt,{optional:!0,skipSelf:!0})??void 0;bindDirectiveInstance=I(T,{self:!0});onAfterViewChecked(){this.bindDirectiveInstance.setAttrs(this.ptms(["host","root"]))}styleClass;shape="rectangle";animation="wave";borderRadius;size;width="100%";height="1rem";_componentStyle=I(qt);get containerStyle(){let t=this._componentStyle?.inlineStyles.root,e;return this.$unstyled()||(this.size?e=x(y({},t),{width:this.size,height:this.size,borderRadius:this.borderRadius}):e=x(y({},t),{width:this.width,height:this.height,borderRadius:this.borderRadius})),e}get dataP(){return this.cn({[this.shape]:this.shape})}static \u0275fac=(()=>{let t;return function(s){return(t||(t=W(r)))(s||r)}})();static \u0275cmp=X({type:r,selectors:[["p-skeleton"]],hostVars:6,hostBindings:function(e,s){e&2&&(j("aria-hidden",!0)("data-p",s.dataP),Z(s.containerStyle),C(s.cn(s.cx("root"),s.styleClass)))},inputs:{styleClass:"styleClass",shape:"shape",animation:"animation",borderRadius:"borderRadius",size:"size",width:"width",height:"height"},features:[tt([qt,{provide:Qt,useExisting:r},{provide:at,useExisting:r}]),G([T]),Y],decls:0,vars:0,template:function(e,s){},dependencies:[et,R],encapsulation:2,changeDetection:0})}return r})(),je=(()=>{class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=J({type:r});static \u0275inj=H({imports:[oe,R,R]})}return r})();var Kt=`
    .p-chip {
        display: inline-flex;
        align-items: center;
        background: dt('chip.background');
        color: dt('chip.color');
        border-radius: dt('chip.border.radius');
        padding-block: dt('chip.padding.y');
        padding-inline: dt('chip.padding.x');
        gap: dt('chip.gap');
    }

    .p-chip-icon {
        color: dt('chip.icon.color');
        font-size: dt('chip.icon.font.size');
        width: dt('chip.icon.size');
        height: dt('chip.icon.size');
    }

    .p-chip-image {
        border-radius: 50%;
        width: dt('chip.image.width');
        height: dt('chip.image.height');
        margin-inline-start: calc(-1 * dt('chip.padding.y'));
    }

    .p-chip:has(.p-chip-remove-icon) {
        padding-inline-end: dt('chip.padding.y');
    }

    .p-chip:has(.p-chip-image) {
        padding-block-start: calc(dt('chip.padding.y') / 2);
        padding-block-end: calc(dt('chip.padding.y') / 2);
    }

    .p-chip-remove-icon {
        cursor: pointer;
        font-size: dt('chip.remove.icon.size');
        width: dt('chip.remove.icon.size');
        height: dt('chip.remove.icon.size');
        color: dt('chip.remove.icon.color');
        border-radius: 50%;
        transition:
            outline-color dt('chip.transition.duration'),
            box-shadow dt('chip.transition.duration');
        outline-color: transparent;
    }

    .p-chip-remove-icon:focus-visible {
        box-shadow: dt('chip.remove.icon.focus.ring.shadow');
        outline: dt('chip.remove.icon.focus.ring.width') dt('chip.remove.icon.focus.ring.style') dt('chip.remove.icon.focus.ring.color');
        outline-offset: dt('chip.remove.icon.focus.ring.offset');
    }
`;var ae=["removeicon"],ce=["*"];function le(r,n){if(r&1){let t=Q();O(0,"img",4),K("error",function(s){L(t);let i=v();return M(i.imageError(s))}),z()}if(r&2){let t=v();C(t.cx("image")),D("pBind",t.ptm("image"))("src",t.image,kt)("alt",t.alt)}}function pe(r,n){if(r&1&&At(0,"span",6),r&2){let t=v(2);C(t.icon),D("pBind",t.ptm("icon"))("ngClass",t.cx("icon"))}}function de(r,n){if(r&1&&N(0,pe,1,4,"span",5),r&2){let t=v();D("ngIf",t.icon)}}function ue(r,n){if(r&1&&(O(0,"div",7),Mt(1),z()),r&2){let t=v();C(t.cx("label")),D("pBind",t.ptm("label")),A(),Rt(t.label)}}function me(r,n){if(r&1){let t=Q();O(0,"span",11),K("click",function(s){L(t);let i=v(3);return M(i.close(s))})("keydown",function(s){L(t);let i=v(3);return M(i.onKeydown(s))}),z()}if(r&2){let t=v(3);C(t.removeIcon),D("pBind",t.ptm("removeIcon"))("ngClass",t.cx("removeIcon")),j("tabindex",t.disabled?-1:0)("aria-label",t.removeAriaLabel)}}function ge(r,n){if(r&1){let t=Q();Et(),O(0,"svg",12),K("click",function(s){L(t);let i=v(3);return M(i.close(s))})("keydown",function(s){L(t);let i=v(3);return M(i.onKeydown(s))}),z()}if(r&2){let t=v(3);C(t.cx("removeIcon")),D("pBind",t.ptm("removeIcon")),j("tabindex",t.disabled?-1:0)("aria-label",t.removeAriaLabel)}}function he(r,n){if(r&1&&(dt(0),N(1,me,1,6,"span",9)(2,ge,1,5,"svg",10),ut()),r&2){let t=v(2);A(),D("ngIf",t.removeIcon),A(),D("ngIf",!t.removeIcon)}}function fe(r,n){}function ye(r,n){r&1&&N(0,fe,0,0,"ng-template")}function be(r,n){if(r&1){let t=Q();O(0,"span",13),K("click",function(s){L(t);let i=v(2);return M(i.close(s))})("keydown",function(s){L(t);let i=v(2);return M(i.onKeydown(s))}),N(1,ye,1,0,null,14),z()}if(r&2){let t=v(2);C(t.cx("removeIcon")),D("pBind",t.ptm("removeIcon")),j("tabindex",t.disabled?-1:0)("aria-label",t.removeAriaLabel),A(),D("ngTemplateOutlet",t.removeIconTemplate||t._removeIconTemplate)}}function ve(r,n){if(r&1&&(dt(0),N(1,he,3,2,"ng-container",3)(2,be,2,6,"span",8),ut()),r&2){let t=v();A(),D("ngIf",!t.removeIconTemplate&&!t._removeIconTemplate),A(),D("ngIf",t.removeIconTemplate||t._removeIconTemplate)}}var De={root:({instance:r})=>({display:!r.visible&&"none"})},we={root:({instance:r})=>["p-chip p-component",{"p-disabled":r.disabled}],image:"p-chip-image",icon:"p-chip-icon",label:"p-chip-label",removeIcon:"p-chip-remove-icon"},Ht=(()=>{class r extends nt{name="chip";style=Kt;classes=we;inlineStyles=De;static \u0275fac=(()=>{let t;return function(s){return(t||(t=W(r)))(s||r)}})();static \u0275prov=b({token:r,factory:r.\u0275fac})}return r})();var $t=new $("CHIP_INSTANCE"),Se=(()=>{class r extends ct{$pcChip=I($t,{optional:!0,skipSelf:!0})??void 0;bindDirectiveInstance=I(T,{self:!0});onAfterViewChecked(){this.bindDirectiveInstance.setAttrs(this.ptms(["host","root"]))}label;icon;image;alt;styleClass;disabled=!1;removable=!1;removeIcon;onRemove=new pt;onImageError=new pt;visible=!0;get removeAriaLabel(){return this.config.getTranslation(Vt.ARIA).removeLabel}get chipProps(){return this._chipProps}set chipProps(t){this._chipProps=t,t&&typeof t=="object"&&Object.entries(t).forEach(([e,s])=>this[`_${e}`]!==s&&(this[`_${e}`]=s))}_chipProps;_componentStyle=I(Ht);removeIconTemplate;templates;_removeIconTemplate;onAfterContentInit(){this.templates.forEach(t=>{switch(t.getType()){case"removeicon":this._removeIconTemplate=t.template;break;default:this._removeIconTemplate=t.template;break}})}onChanges(t){if(t.chipProps&&t.chipProps.currentValue){let{currentValue:e}=t.chipProps;e.label!==void 0&&(this.label=e.label),e.icon!==void 0&&(this.icon=e.icon),e.image!==void 0&&(this.image=e.image),e.alt!==void 0&&(this.alt=e.alt),e.styleClass!==void 0&&(this.styleClass=e.styleClass),e.removable!==void 0&&(this.removable=e.removable),e.removeIcon!==void 0&&(this.removeIcon=e.removeIcon)}}close(t){this.visible=!1,this.onRemove.emit(t)}onKeydown(t){(t.key==="Enter"||t.key==="Backspace")&&this.close(t)}imageError(t){this.onImageError.emit(t)}get dataP(){return this.cn({removable:this.removable})}static \u0275fac=(()=>{let t;return function(s){return(t||(t=W(r)))(s||r)}})();static \u0275cmp=X({type:r,selectors:[["p-chip"]],contentQueries:function(e,s,i){if(e&1&&Tt(i,ae,4)(i,Ut,4),e&2){let o;mt(o=gt())&&(s.removeIconTemplate=o.first),mt(o=gt())&&(s.templates=o)}},hostVars:6,hostBindings:function(e,s){e&2&&(j("aria-label",s.label)("data-p",s.dataP),Z(s.sx("root")),C(s.cn(s.cx("root"),s.styleClass)))},inputs:{label:"label",icon:"icon",image:"image",alt:"alt",styleClass:"styleClass",disabled:[2,"disabled","disabled",ht],removable:[2,"removable","removable",ht],removeIcon:"removeIcon",chipProps:"chipProps"},outputs:{onRemove:"onRemove",onImageError:"onImageError"},features:[tt([Ht,{provide:$t,useExisting:r},{provide:at,useExisting:r}]),G([T]),Y],ngContentSelectors:ce,decls:6,vars:4,consts:[["iconTemplate",""],[3,"pBind","class","src","alt","error",4,"ngIf","ngIfElse"],[3,"pBind","class",4,"ngIf"],[4,"ngIf"],[3,"error","pBind","src","alt"],[3,"pBind","class","ngClass",4,"ngIf"],[3,"pBind","ngClass"],[3,"pBind"],["role","button",3,"pBind","class","click","keydown",4,"ngIf"],["role","button",3,"pBind","class","ngClass","click","keydown",4,"ngIf"],["data-p-icon","times-circle","role","button",3,"pBind","class","click","keydown",4,"ngIf"],["role","button",3,"click","keydown","pBind","ngClass"],["data-p-icon","times-circle","role","button",3,"click","keydown","pBind"],["role","button",3,"click","keydown","pBind"],[4,"ngTemplateOutlet"]],template:function(e,s){if(e&1&&(Ct(),Ft(0),N(1,le,1,5,"img",1)(2,de,1,1,"ng-template",null,0,Bt)(4,ue,2,4,"div",2)(5,ve,3,2,"ng-container",3)),e&2){let i=Lt(3);A(),D("ngIf",s.image)("ngIfElse",i),A(3),D("ngIf",s.label),A(),D("ngIf",s.removable)}},dependencies:[et,Pt,Nt,jt,Ot,R,T],encapsulation:2,changeDetection:0})}return r})(),an=(()=>{class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=J({type:r});static \u0275inj=H({imports:[Se,R,R]})}return r})();var lt=class r{firestore=k.getFirestore();authService=I(q);stats=d(null);isLoading=d(!1);error=d(null);async loadDashboardStats(){try{this.isLoading.set(!0),this.error.set(null);let n=this.authService.getCurrentUserUid();if(!n)throw new Error("User not authenticated");let e=(await f(h(u(this.firestore,"workspaces"),c("userId","==",n)))).docs.map(p=>{let l=p.data();return bt.fromFirestore(p.id,l)}),s=e.map(p=>p.id);if(s.length===0){let p={domainsExpiring7Days:0,domainsExpiring15Days:0,domainsExpiring30Days:0,domainsExpiring60Days:0,subscriptionsExpiring7Days:0,subscriptionsExpiring15Days:0,subscriptionsExpiring30Days:0,subscriptionsExpiring60Days:0,totalWorkspaces:0,activeWorkspaces:0,workspacesInError:[],totalDomains:0,totalSubscriptions:0};return this.stats.set(p),p}let i=await this.getDomainsForWorkspaces(s),o=await this.getSubscriptionsForWorkspaces(s),a=new Date,g=new Date(a.getTime()+10080*60*1e3),w=new Date(a.getTime()+360*60*60*1e3),V=new Date(a.getTime()+720*60*60*1e3),m=new Date(a.getTime()+1440*60*60*1e3),S=i.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=g&&l>a}).length,F=i.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=w&&l>a}).length,Xt=i.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=V&&l>a}).length,Jt=i.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=m&&l>a}).length,Gt=o.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=g&&l>a}).length,Yt=o.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=w&&l>a}).length,Zt=o.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=V&&l>a}).length,te=o.filter(p=>{let l=this.toDate(p.expiresAt);return l&&l<=m&&l>a}).length,ee=e.filter(p=>p.status==="ACTIVE").length,ne=e.filter(p=>p.status!=="ACTIVE"),_t={domainsExpiring7Days:S,domainsExpiring15Days:F,domainsExpiring30Days:Xt,domainsExpiring60Days:Jt,subscriptionsExpiring7Days:Gt,subscriptionsExpiring15Days:Yt,subscriptionsExpiring30Days:Zt,subscriptionsExpiring60Days:te,totalWorkspaces:e.length,activeWorkspaces:ee,workspacesInError:ne,totalDomains:i.length,totalSubscriptions:o.length};return this.stats.set(_t),_t}catch(n){let t=n instanceof Error?n.message:"Failed to load dashboard stats";throw this.error.set(t),console.error("Error loading dashboard stats:",n),n}finally{this.isLoading.set(!1)}}async getDomainsForWorkspaces(n){let t=[];for(let s=0;s<n.length;s+=30){let i=n.slice(s,s+30);(await f(h(u(this.firestore,"domains"),c("workspaceId","in",i)))).docs.forEach(a=>t.push(a.data()))}return t}async getSubscriptionsForWorkspaces(n){let t=[];for(let s=0;s<n.length;s+=30){let i=n.slice(s,s+30);(await f(h(u(this.firestore,"subscriptions"),c("workspaceId","in",i)))).docs.forEach(a=>t.push(a.data()))}return t}toDate(n){return n?n instanceof Date?n:n instanceof _?n.toDate():typeof n=="object"&&"seconds"in n?new Date(n.seconds*1e3):null:null}clearError(){this.error.set(null)}getExpirationTrends(){let n=this.stats();return n?[{label:"7 d\xEDas",domains:n.domainsExpiring7Days,subscriptions:n.subscriptionsExpiring7Days},{label:"15 d\xEDas",domains:n.domainsExpiring15Days,subscriptions:n.subscriptionsExpiring15Days},{label:"30 d\xEDas",domains:n.domainsExpiring30Days,subscriptions:n.subscriptionsExpiring30Days},{label:"60 d\xEDas",domains:n.domainsExpiring60Days,subscriptions:n.subscriptionsExpiring60Days}]:[]}async getUpcomingEvents(n=10){try{let t=this.authService.getCurrentUserUid();if(!t)return[];let s=(await f(h(u(this.firestore,"workspaces"),c("userId","==",t)))).docs.map(m=>{let S=m.data();return bt.fromFirestore(m.id,S)}),i=s.map(m=>m.id);if(i.length===0)return[];let o=new Map(s.map(m=>[m.id,m.name])),a=await this.getDomainsForWorkspaces(i),g=await this.getSubscriptionsForWorkspaces(i),w=new Date,V=[];return a.forEach(m=>{let S=this.toDate(m.expiresAt);if(!S||S<=w)return;let F=Math.ceil((S.getTime()-w.getTime())/(1e3*60*60*24));V.push({id:m.id,title:m.domainName,type:"domain",expirationDate:S,workspaceName:o.get(m.workspaceId)||"Unknown",daysUntilExpiration:F,status:F<=7?"critical":F<=15?"warning":"info"})}),g.forEach(m=>{let S=this.toDate(m.expiresAt);if(!S||S<=w)return;let F=Math.ceil((S.getTime()-w.getTime())/(1e3*60*60*24));V.push({id:m.id,title:m.productName,type:"subscription",expirationDate:S,workspaceName:o.get(m.workspaceId)||"Unknown",daysUntilExpiration:F,status:F<=7?"critical":F<=15?"warning":"info"})}),V.sort((m,S)=>m.daysUntilExpiration-S.daysUntilExpiration).slice(0,n)}catch(t){return console.error("Error getting upcoming events:",t),[]}}getStatsComparison(){let n=this.stats();return n?[{label:"Total Workspaces",current:n.totalWorkspaces,previous:Math.max(0,n.totalWorkspaces-1)},{label:"Dominios",current:n.totalDomains,previous:Math.max(0,n.totalDomains-Math.floor(Math.random()*5))},{label:"Suscripciones",current:n.totalSubscriptions,previous:Math.max(0,n.totalSubscriptions-Math.floor(Math.random()*3))},{label:"Vencimientos (7d)",current:n.domainsExpiring7Days+n.subscriptionsExpiring7Days,previous:Math.floor((n.domainsExpiring7Days+n.subscriptionsExpiring7Days)*(.8+Math.random()*.4))}]:[]}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var vt=class r{firestore=k.getFirestore();alerts=d([]);isLoading=d(!1);error=d(null);async getAlertsByWorkspace(n,t){this.isLoading.set(!0),this.error.set(null);try{let e=u(this.firestore,"alert_logs"),s=[c("workspaceId","==",n),E("createdAt","desc")];t?.entityType&&s.push(c("entityType","==",t.entityType)),t?.daysBefore!==void 0&&s.push(c("daysBefore","==",t.daysBefore)),t?.processed!==void 0&&s.push(c("processed","==",t.processed));let i=h(e,...s),a=(await f(i)).docs.map(g=>{let w=g.data();return new ot(x(y({},w),{id:g.id}))});return this.alerts.set(a),a}catch(e){let s=e instanceof Error?e.message:"Error al cargar alertas";throw this.error.set(s),console.error("Error fetching alerts:",e),e}finally{this.isLoading.set(!1)}}async getAlertsByEntity(n,t,e){this.isLoading.set(!0),this.error.set(null);try{let s=u(this.firestore,"alert_logs"),i=h(s,c("workspaceId","==",n),c("entityId","==",t),c("entityType","==",e),E("createdAt","desc"));return(await f(i)).docs.map(g=>{let w=g.data();return new ot(x(y({},w),{id:g.id}))})}catch(s){let i=s instanceof Error?s.message:"Error al cargar alertas de entidad";throw this.error.set(i),console.error("Error fetching entity alerts:",s),s}finally{this.isLoading.set(!1)}}async getCriticalAlerts(n){this.isLoading.set(!0),this.error.set(null);try{let t=_.fromDate(new Date(Date.now()-6048e5)),e=u(this.firestore,"alert_logs"),s=h(e,c("workspaceId","==",n),c("daysBefore","<=",7),c("createdAt",">=",t),E("createdAt","desc"));return(await f(s)).docs.map(a=>{let g=a.data();return new ot(x(y({},g),{id:a.id}))})}catch(t){let e=t instanceof Error?t.message:"Error al cargar alertas cr\xEDticas";throw this.error.set(e),console.error("Error fetching critical alerts:",t),t}finally{this.isLoading.set(!1)}}async getAlertStats(n){let t=await this.getAlertsByWorkspace(n);return{totalAlerts:t.length,criticalAlerts:t.filter(s=>s.isCritical()).length,warningAlerts:t.filter(s=>s.isWarning()).length,infoAlerts:t.filter(s=>s.isInfo()).length,byEntityType:{domains:t.filter(s=>s.entityType==="domain").length,subscriptions:t.filter(s=>s.entityType==="subscription").length}}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var Dt=class r{firestore=k.getFirestore();auditLogs=d([]);isLoading=d(!1);error=d(null);async getAuditLogs(n){this.isLoading.set(!0),this.error.set(null);try{let t=u(this.firestore,"audit_logs"),e=[E("createdAt","desc")];n?.workspaceId&&e.push(c("workspaceId","==",n.workspaceId)),n?.actorUid&&e.push(c("actorUid","==",n.actorUid)),n?.action&&e.push(c("action","==",n.action)),n?.status&&e.push(c("status","==",n.status)),n?.startDate&&e.push(c("createdAt",">=",_.fromDate(n.startDate))),n?.endDate&&e.push(c("createdAt","<=",_.fromDate(n.endDate))),n?.limitCount&&e.push(B(n.limitCount));let s=h(t,...e),o=(await f(s)).docs.map(a=>{let g=a.data();return new Wt(x(y({},g),{id:a.id}))});return this.auditLogs.set(o),o}catch(t){let e=t instanceof Error?t.message:"Error al cargar audit logs";throw this.error.set(e),console.error("Error fetching audit logs:",t),t}finally{this.isLoading.set(!1)}}async getWorkspaceAuditLogs(n,t=50){return this.getAuditLogs({workspaceId:n,limitCount:t})}async getRecentAuditLogs(n=100){let t=new Date(Date.now()-864e5);return this.getAuditLogs({startDate:t,limitCount:n})}async getFailedAuditLogs(n,t=50){return this.getAuditLogs({workspaceId:n,status:"failed",limitCount:t})}async getAuditStats(n){let t=await this.getAuditLogs({workspaceId:n,limitCount:1e3}),e={total:t.length,success:t.filter(s=>s.isSuccess()).length,failure:t.filter(s=>s.isFailure()).length,partial:t.filter(s=>s.isPartial()).length,byAction:{}};return t.forEach(s=>{e.byAction[s.action]=(e.byAction[s.action]||0)+1}),e}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var wt=class r{firestore=k.getFirestore();syncRuns=d([]);isLoading=d(!1);error=d(null);async getSyncRunsByWorkspace(n,t=50){this.isLoading.set(!0),this.error.set(null);try{let e=u(this.firestore,"sync_runs"),s=h(e,c("workspaceId","==",n),E("startedAt","desc"),B(t)),o=(await f(s)).docs.map(a=>{let g=a.data();return new it(x(y({},g),{id:a.id}))});return this.syncRuns.set(o),o}catch(e){let s=e instanceof Error?e.message:"Error al cargar sync runs";throw this.error.set(s),console.error("Error fetching sync runs:",e),e}finally{this.isLoading.set(!1)}}async getRecentSyncRuns(n=100){this.isLoading.set(!0),this.error.set(null);try{let t=u(this.firestore,"sync_runs"),e=h(t,E("startedAt","desc"),B(n)),i=(await f(e)).docs.map(o=>{let a=o.data();return new it(x(y({},a),{id:o.id}))});return this.syncRuns.set(i),i}catch(t){let e=t instanceof Error?t.message:"Error al cargar sync runs";throw this.error.set(e),console.error("Error fetching sync runs:",t),t}finally{this.isLoading.set(!1)}}async getFailedSyncRuns(n,t=50){this.isLoading.set(!0),this.error.set(null);try{let e=u(this.firestore,"sync_runs"),s=[c("status","==","failed"),E("startedAt","desc"),B(t)];n&&s.unshift(c("workspaceId","==",n));let i=h(e,...s);return(await f(i)).docs.map(g=>{let w=g.data();return new it(x(y({},w),{id:g.id}))})}catch(e){let s=e instanceof Error?e.message:"Error al cargar sync runs fallidos";throw this.error.set(s),console.error("Error fetching failed sync runs:",e),e}finally{this.isLoading.set(!1)}}async getSyncStats(n){let t=await this.getSyncRunsByWorkspace(n,100);return{totalRuns:t.length,successfulRuns:t.filter(s=>s.isSuccess()).length,failedRuns:t.filter(s=>s.isFailed()).length,partialRuns:t.filter(s=>s.isPartialSuccess&&s.isPartialSuccess()).length,totalDomains:t.reduce((s,i)=>s+(i.domainsProcessed||0),0),totalSubscriptions:t.reduce((s,i)=>s+(i.subscriptionsProcessed||0),0),averageDuration:t.length>0?t.reduce((s,i)=>s+(i.getDurationMs()||0),0)/t.length:0,lastSyncDate:t.length>0?t[0].startAt.toDate():null}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var St=class r{exportToCSV(n,t,e){if(!n||n.length===0){console.warn("No data to export");return}let s=e?e.map(a=>a.label):Object.keys(n[0]),i=e?e.map(a=>a.key):Object.keys(n[0]),o=[s.join(","),...n.map(a=>i.map(g=>{let w=a[g];return this.escapeCSVValue(w)}).join(","))].join(`
`);this.downloadFile(o,t,"text/csv;charset=utf-8;")}exportToJSON(n,t){let e=JSON.stringify(n,null,2);this.downloadFile(e,t,"application/json")}escapeCSVValue(n){if(n==null)return"";let t;return n instanceof Date?t=n.toISOString():typeof n=="object"?t=JSON.stringify(n):t=String(n),t.includes(",")||t.includes('"')||t.includes(`
`)?`"${t.replace(/"/g,'""')}"`:t}downloadFile(n,t,e){let s=new Blob([n],{type:e}),i=window.URL.createObjectURL(s),o=document.createElement("a");o.href=i,o.download=t,o.click(),window.URL.revokeObjectURL(i)}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var xt=class r{firestore=k.getFirestore();authService=I(q);savedFilters=d([]);currentFilter=d(null);isLoading=d(!1);error=d(null);async loadSavedFilters(){try{this.isLoading.set(!0),this.error.set(null);let n=this.authService.getCurrentUserUid();if(!n)throw new Error("User not authenticated");let t=h(u(this.firestore,"savedFilters"),c("userId","==",n)),s=(await f(t)).docs.map(i=>y({id:i.id},i.data()));return this.savedFilters.set(s),s}catch(n){let t=n instanceof Error?n.message:"Failed to load filters";throw this.error.set(t),n}finally{this.isLoading.set(!1)}}async saveFilter(n,t,e,s=!1){try{let i=this.authService.getCurrentUserUid();if(!i)throw new Error("User not authenticated");s&&await this.clearDefaultFilters(i);let o={userId:i,name:n,description:e,criteria:t,isDefault:s,createdAt:U(),updatedAt:U()},a=await rt(u(this.firestore,"savedFilters"),o);return await this.loadSavedFilters(),a.id}catch(i){let o=i instanceof Error?i.message:"Failed to save filter";throw this.error.set(o),i}}async updateFilter(n,t){try{if(t.isDefault){let e=this.authService.getCurrentUserUid();e&&await this.clearDefaultFilters(e,n)}await yt(ft(this.firestore,"savedFilters",n),x(y({},t),{updatedAt:U()})),await this.loadSavedFilters()}catch(e){let s=e instanceof Error?e.message:"Failed to update filter";throw this.error.set(s),e}}async deleteFilter(n){try{await st(ft(this.firestore,"savedFilters",n)),await this.loadSavedFilters()}catch(t){let e=t instanceof Error?t.message:"Failed to delete filter";throw this.error.set(e),t}}applyFilter(n,t){let e=[...n];if(t.name){let s=t.name.toLowerCase();e=e.filter(i=>i.name.toLowerCase().includes(s))}return t.status&&t.status.length>0&&(e=e.filter(s=>t.status.includes(s.status))),t.tags&&t.tags.length>0&&(e=e.filter(s=>t.tags.some(i=>s.tags?.includes(i)))),t.priority&&t.priority.length>0&&(e=e.filter(s=>s.priority&&t.priority.includes(s.priority))),t.favoritesOnly&&(e=e.filter(s=>s.isFavorite)),t.hasErrors!==void 0&&(e=e.filter(s=>{let i=s.status!=="ACTIVE";return t.hasErrors?i:!i})),(t.lastSyncAfter||t.lastSyncBefore)&&(e=e.filter(s=>{if(!s.lastSyncAt)return!1;let i=s.lastSyncAt instanceof _?s.lastSyncAt.toDate():s.lastSyncAt;return!(t.lastSyncAfter&&i<t.lastSyncAfter||t.lastSyncBefore&&i>t.lastSyncBefore)})),e}async clearDefaultFilters(n,t){let e=h(u(this.firestore,"savedFilters"),c("userId","==",n),c("isDefault","==",!0)),i=(await f(e)).docs.filter(o=>o.id!==t).map(o=>yt(o.ref,{isDefault:!1,updatedAt:U()}));await Promise.all(i)}setCurrentFilter(n){this.currentFilter.set(n)}clearFilter(){this.currentFilter.set(null)}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var It=class r{firestore=k.getFirestore();authService=I(q);dashboardService=I(lt);snapshots=d([]);isLoading=d(!1);error=d(null);async createSnapshot(){try{this.isLoading.set(!0),this.error.set(null);let n=this.authService.getCurrentUserUid();if(!n)throw new Error("User not authenticated");let t=await this.dashboardService.loadDashboardStats(),e={userId:n,snapshotAt:U(),totalWorkspaces:t.totalWorkspaces,activeWorkspaces:t.activeWorkspaces,totalDomains:t.totalDomains,totalSubscriptions:t.totalSubscriptions,domainsExpiring7Days:t.domainsExpiring7Days,domainsExpiring15Days:t.domainsExpiring15Days,domainsExpiring30Days:t.domainsExpiring30Days,domainsExpiring60Days:t.domainsExpiring60Days,subscriptionsExpiring7Days:t.subscriptionsExpiring7Days,subscriptionsExpiring15Days:t.subscriptionsExpiring15Days,subscriptionsExpiring30Days:t.subscriptionsExpiring30Days,subscriptionsExpiring60Days:t.subscriptionsExpiring60Days,workspacesInError:t.workspacesInError.length},s=await rt(u(this.firestore,"dashboardSnapshots"),e);return await this.loadSnapshots(),s.id}catch(n){let t=n instanceof Error?n.message:"Failed to create snapshot";throw this.error.set(t),n}finally{this.isLoading.set(!1)}}async loadSnapshots(n=30){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=h(u(this.firestore,"dashboardSnapshots"),c("userId","==",t),E("snapshotAt","desc"),B(n)),i=(await f(e)).docs.map(o=>y({id:o.id},o.data()));return this.snapshots.set(i),i}catch(t){let e=t instanceof Error?t.message:"Failed to load snapshots";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}getComparisonData(n=this.snapshots()){let t=[...n].sort((e,s)=>{let i=e.snapshotAt instanceof _?e.snapshotAt.toDate():e.snapshotAt,o=s.snapshotAt instanceof _?s.snapshotAt.toDate():s.snapshotAt;return i.getTime()-o.getTime()});return{labels:t.map(e=>(e.snapshotAt instanceof _?e.snapshotAt.toDate():e.snapshotAt).toLocaleDateString("es-ES",{month:"short",day:"numeric"})),workspaces:t.map(e=>e.totalWorkspaces),domains:t.map(e=>e.totalDomains),subscriptions:t.map(e=>e.totalSubscriptions)}}getChangeMetrics(n,t){return{workspaceChange:n.totalWorkspaces-t.totalWorkspaces,domainChange:n.totalDomains-t.totalDomains,subscriptionChange:n.totalSubscriptions-t.totalSubscriptions,expiringDomainsChange:n.domainsExpiring7Days-t.domainsExpiring7Days}}async deleteOldSnapshots(n=90){try{let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=new Date;e.setDate(e.getDate()-n);let s=h(u(this.firestore,"dashboardSnapshots"),c("userId","==",t),c("snapshotAt","<",_.fromDate(e))),o=(await f(s)).docs.map(a=>st(a.ref));await Promise.all(o),await this.loadSnapshots()}catch(t){let e=t instanceof Error?t.message:"Failed to delete old snapshots";throw this.error.set(e),t}}getLatestSnapshot(){let n=this.snapshots();return n.length===0?null:n[0]}getSnapshotDaysAgo(n){let t=new Date;return t.setDate(t.getDate()-n),this.snapshots().find(e=>(e.snapshotAt instanceof _?e.snapshotAt.toDate():e.snapshotAt).toDateString()===t.toDateString())||null}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};export{oe as a,je as b,Se as c,an as d,lt as e,vt as f,Dt as g,wt as h,St as i,xt as j};

import{a as L}from"./chunk-2RWR6RJP.js";import{c,j as U}from"./chunk-LSJGMPCD.js";import{a as F}from"./chunk-HPQ7OMYE.js";import{Ia as k,Ja as y,Ka as d,La as v,Ma as C,Qa as E,Ra as I,Sa as S,Ta as T,Ua as D,Xa as m,m as g,o as W}from"./chunk-M5CBQPDY.js";import{O as b,T as i,a as h,ia as u,m as A,r as f}from"./chunk-ZVXIGZDY.js";var P=class p{firestore=m.getFirestore();auth=m.getAuth();http=i(W);authService=i(F);encryptionService=i(L);hostingerApi=i(U);collectionName="workspaces";cloudFunctionUrl="https://us-central1-hostinger-workspace-manager.cloudfunctions.net/syncWorkspace";syncAllUrl="https://us-central1-hostinger-workspace-manager.cloudfunctions.net/syncAllWorkspaces";workspaces=u([]);isLoading=u(!1);error=u(null);async getAllWorkspaces(){try{this.isLoading.set(!0),this.error.set(null);let r=this.authService.getCurrentUserUid();if(!r)throw new Error("User not authenticated");let e=y(this.firestore,this.collectionName),t=v(e,C("userId","==",r)),o=(await I(t)).docs.map(n=>{let a=n.data();return c.fromFirestore(n.id,a)});return o.sort((n,a)=>{let l=n.createdAt instanceof Date?n.createdAt.getTime():0;return(a.createdAt instanceof Date?a.createdAt.getTime():0)-l}),this.workspaces.set(o),o}catch(r){let e=r instanceof Error?r.message:"Failed to fetch workspaces";throw this.error.set(e),console.error("Error loading workspaces:",r),r}finally{this.isLoading.set(!1)}}async getWorkspaceByIdAsync(r){try{this.isLoading.set(!0),this.error.set(null);let e=d(this.firestore,this.collectionName,r),t=await E(e);if(!t.exists())return null;let s=t.data();return c.fromFirestore(t.id,s)}catch(e){let t=e instanceof Error?e.message:"Failed to fetch workspace";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}getWorkspaceById(r){return A(this.getWorkspaceByIdAsync(r))}async createWorkspace(r){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let t=k.now(),s=r.token?this.encryptionService.encrypt(r.token):void 0,o={name:r.name,description:r.description,encryptedToken:s,userId:e,createdAt:t,updatedAt:t,status:r.status||"ACTIVE"},n=y(this.firestore,this.collectionName),a=await D(n,o),l=c.fromFirestore(a.id,o);return this.workspaces.update(w=>[l,...w]),l}catch(e){let t=e instanceof Error?e.message:"Failed to create workspace";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}async updateWorkspace(r,e){try{this.isLoading.set(!0),this.error.set(null);let t=d(this.firestore,this.collectionName,r),s={updatedAt:k.now()};e.name!==void 0&&(s.name=e.name),e.description!==void 0&&(s.description=e.description),e.status!==void 0&&(s.status=e.status),e.token&&(s.encryptedToken=this.encryptionService.encrypt(e.token)),await S(t,s),this.workspaces.update(o=>o.map(n=>{if(n.id===r){let a=h(h({},n.toFirestore()),s);return c.fromFirestore(r,a)}return n}))}catch(t){let s=t instanceof Error?t.message:"Failed to update workspace";throw this.error.set(s),t}finally{this.isLoading.set(!1)}}async disableWorkspace(r){await this.updateWorkspace(r,{status:"DISABLED"})}async deleteWorkspace(r){try{this.isLoading.set(!0),this.error.set(null);let e=d(this.firestore,this.collectionName,r);await T(e),this.workspaces.update(t=>t.filter(s=>s.id!==r))}catch(e){let t=e instanceof Error?e.message:"Failed to delete workspace";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}getActiveWorkspacesCount(){return this.workspaces().filter(r=>r.status==="ACTIVE").length}async syncNow(r){try{if(this.isLoading.set(!0),this.error.set(null),!await this.getWorkspaceByIdAsync(r))throw new Error("Workspace not found");console.log("\u{1F504} Calling syncWorkspace function...",{workspaceId:r,cloudFunctionUrl:this.cloudFunctionUrl});let t=this.auth.currentUser;if(!t)throw new Error("User not authenticated");let s=await t.getIdToken(),o=await f(this.http.post(this.cloudFunctionUrl,{workspaceId:r},{headers:new g({Authorization:`Bearer ${s}`,"Content-Type":"application/json"})}));if(console.log("\u2705 Function response:",o),!o.success)throw new Error(o.error||"Sync failed");await this.getAllWorkspaces()}catch(e){console.error("\u274C Sync error:",e);let t=e instanceof Error?e.message:"Failed to sync workspace";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}clearError(){this.error.set(null)}async syncAllWorkspaces(){try{this.isLoading.set(!0),this.error.set(null),console.log("\u{1F504} Starting batch sync for all workspaces...");let r=this.auth.currentUser;if(!r)throw new Error("User not authenticated");let e=await r.getIdToken(),t=await f(this.http.post(this.syncAllUrl,{},{headers:new g({Authorization:`Bearer ${e}`,"Content-Type":"application/json"})}));if(console.log("\u2705 Batch sync response:",t),!t.success)throw new Error("Batch sync failed");return await this.getAllWorkspaces(),{success:t.success,totalWorkspaces:t.totalWorkspaces,successCount:t.successCount,failureCount:t.failureCount,skippedCount:t.skippedCount,disabledCount:t.disabledCount}}catch(r){console.error("\u274C Batch sync error:",r);let e=r instanceof Error?r.message:"Failed to sync all workspaces";throw this.error.set(e),r}finally{this.isLoading.set(!1)}}getLastGlobalSync(){let r=this.workspaces();if(r.length===0)return null;let e=null;for(let t of r)if(t.lastSyncAt){let s=t.lastSyncAt instanceof Date?t.lastSyncAt:t.lastSyncAt.toDate();(!e||s>e)&&(e=s)}return e}async testConnection(r){try{this.isLoading.set(!0),this.error.set(null);let e=await this.getWorkspaceByIdAsync(r);if(!e)return{success:!1,error:"Workspace no encontrado"};if(!e.encryptedToken)return{success:!1,error:"No hay token configurado"};let t=this.encryptionService.decrypt(e.encryptedToken);if(!t)return{success:!1,error:"Error al descifrar el token"};let s=await this.hostingerApi.testConnection(t),o={lastTestedAt:new Date};return s.success?(o.status="ACTIVE",o.lastTestError=void 0):(o.status="INVALID_TOKEN",o.lastTestError=s.error),await this.updateWorkspace(r,o),s}catch(e){let t=e instanceof Error?e.message:"Error al probar conexi\xF3n";return this.error.set(t),{success:!1,error:t}}finally{this.isLoading.set(!1)}}static \u0275fac=function(e){return new(e||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{P as a};

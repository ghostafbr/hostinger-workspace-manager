import{c as _,d as J,e as Y,f as ye,g as K,h as we,i as De}from"./chunk-HD6MQK7W.js";import{a as q}from"./chunk-DTZPPQAO.js";import{Ka as b,La as d,Ma as P,Na as f,Oa as n,Pa as A,Qa as M,Ra as pe,Sa as fe,Ta as m,Ua as U,Va as B,Wa as O,Xa as $,Za as x,o as ge,q as he}from"./chunk-B5FRUK7K.js";import{O as k,T as H,a as w,b as E,ia as u,wc as V}from"./chunk-PY5EWUYY.js";var G=class c{firestore=x.getFirestore();authService=H(q);stats=u(null);isLoading=u(!1);error=u(null);async loadDashboardStats(){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let r=(await m(f(d(this.firestore,"workspaces"),n("userId","==",t)))).docs.map(y=>{let h=y.data();return _.fromFirestore(y.id,h)}),s=r.map(y=>y.id);if(s.length===0){let y={domainsExpiring7Days:0,domainsExpiring15Days:0,domainsExpiring30Days:0,domainsExpiring60Days:0,subscriptionsExpiring7Days:0,subscriptionsExpiring15Days:0,subscriptionsExpiring30Days:0,subscriptionsExpiring60Days:0,totalWorkspaces:0,activeWorkspaces:0,workspacesInError:[],totalDomains:0,totalSubscriptions:0};return this.stats.set(y),y}let a=await this.getDomainsForWorkspaces(s),o=await this.getSubscriptionsForWorkspaces(s),i=new Date,l=new Date(i.getTime()+10080*60*1e3),p=new Date(i.getTime()+360*60*60*1e3),F=new Date(i.getTime()+720*60*60*1e3),g=new Date(i.getTime()+1440*60*60*1e3),v=a.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=l&&h>i}).length,L=a.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=p&&h>i}).length,N=a.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=F&&h>i}).length,C=a.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=g&&h>i}).length,W=o.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=l&&h>i}).length,S=o.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=p&&h>i}).length,I=o.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=F&&h>i}).length,j=o.filter(y=>{let h=this.toDate(y.expiresAt);return h&&h<=g&&h>i}).length,ue=r.filter(y=>y.status==="ACTIVE").length,X=r.filter(y=>y.status!=="ACTIVE"),Q={domainsExpiring7Days:v,domainsExpiring15Days:L,domainsExpiring30Days:N,domainsExpiring60Days:C,subscriptionsExpiring7Days:W,subscriptionsExpiring15Days:S,subscriptionsExpiring30Days:I,subscriptionsExpiring60Days:j,totalWorkspaces:r.length,activeWorkspaces:ue,workspacesInError:X,totalDomains:a.length,totalSubscriptions:o.length};return this.stats.set(Q),Q}catch(t){let e=t instanceof Error?t.message:"Failed to load dashboard stats";throw this.error.set(e),console.error("Error loading dashboard stats:",t),t}finally{this.isLoading.set(!1)}}async getDomainsForWorkspaces(t){let e=[];for(let s=0;s<t.length;s+=30){let a=t.slice(s,s+30);(await m(f(d(this.firestore,"domains"),n("workspaceId","in",a)))).docs.forEach(i=>e.push(i.data()))}return e}async getSubscriptionsForWorkspaces(t){let e=[];for(let s=0;s<t.length;s+=30){let a=t.slice(s,s+30);(await m(f(d(this.firestore,"subscriptions"),n("workspaceId","in",a)))).docs.forEach(i=>e.push(i.data()))}return e}toDate(t){return t?t instanceof Date?t:t instanceof b?t.toDate():typeof t=="object"&&"seconds"in t?new Date(t.seconds*1e3):null:null}clearError(){this.error.set(null)}getExpirationTrends(){let t=this.stats();return t?[{label:"7 d\xEDas",domains:t.domainsExpiring7Days,subscriptions:t.subscriptionsExpiring7Days},{label:"15 d\xEDas",domains:t.domainsExpiring15Days,subscriptions:t.subscriptionsExpiring15Days},{label:"30 d\xEDas",domains:t.domainsExpiring30Days,subscriptions:t.subscriptionsExpiring30Days},{label:"60 d\xEDas",domains:t.domainsExpiring60Days,subscriptions:t.subscriptionsExpiring60Days}]:[]}async getUpcomingEvents(t=10){try{let e=this.authService.getCurrentUserUid();if(!e)return[];let s=(await m(f(d(this.firestore,"workspaces"),n("userId","==",e)))).docs.map(g=>{let v=g.data();return _.fromFirestore(g.id,v)}),a=s.map(g=>g.id);if(a.length===0)return[];let o=new Map(s.map(g=>[g.id,g.name])),i=await this.getDomainsForWorkspaces(a),l=await this.getSubscriptionsForWorkspaces(a),p=new Date,F=[];return i.forEach(g=>{let v=this.toDate(g.expiresAt);if(!v||v<=p)return;let L=Math.ceil((v.getTime()-p.getTime())/(1e3*60*60*24));F.push({id:g.id,title:g.domainName,type:"domain",expirationDate:v,workspaceName:o.get(g.workspaceId)||"Unknown",daysUntilExpiration:L,status:L<=7?"critical":L<=15?"warning":"info"})}),l.forEach(g=>{let v=this.toDate(g.expiresAt);if(!v||v<=p)return;let L=Math.ceil((v.getTime()-p.getTime())/(1e3*60*60*24));F.push({id:g.id,title:g.productName,type:"subscription",expirationDate:v,workspaceName:o.get(g.workspaceId)||"Unknown",daysUntilExpiration:L,status:L<=7?"critical":L<=15?"warning":"info"})}),F.sort((g,v)=>g.daysUntilExpiration-v.daysUntilExpiration).slice(0,t)}catch(e){return console.error("Error getting upcoming events:",e),[]}}getStatsComparison(){let t=this.stats();return t?[{label:"Total Workspaces",current:t.totalWorkspaces,previous:Math.max(0,t.totalWorkspaces-1)},{label:"Dominios",current:t.totalDomains,previous:Math.max(0,t.totalDomains-Math.floor(Math.random()*5))},{label:"Suscripciones",current:t.totalSubscriptions,previous:Math.max(0,t.totalSubscriptions-Math.floor(Math.random()*3))},{label:"Vencimientos (7d)",current:t.domainsExpiring7Days+t.subscriptionsExpiring7Days,previous:Math.floor((t.domainsExpiring7Days+t.subscriptionsExpiring7Days)*(.8+Math.random()*.4))}]:[]}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var ee=class c{firestore=x.getFirestore();isLoading=u(!1);error=u(null);async getDomains(t){try{this.isLoading.set(!0),this.error.set(null);let e=[n("workspaceId","==",t.workspaceId)];if(t.daysToExpire!==void 0){let p=new Date;p.setDate(p.getDate()+t.daysToExpire),e.push(n("expiresAt","<=",p))}e.push(A("expiresAt","asc"));let r=t.pageSize||20;e.push(M(r+1)),t.lastDoc&&e.push(pe(t.lastDoc));let s=f(d(this.firestore,"domains"),...e),a=await m(s),o=a.docs.map(p=>E(w({},p.data()),{id:p.id}));if(t.searchText){let p=t.searchText.toLowerCase();o=o.filter(F=>F.domainName?.toLowerCase().includes(p))}let i=o.length>r;i&&(o=o.slice(0,r));let l=o.length>0?a.docs[o.length-1]:null;return{domains:o,lastDoc:l,hasMore:i}}catch(e){let r=e instanceof Error?e.message:"Error desconocido";throw this.error.set(r),console.error("Error fetching domains:",e),e}finally{this.isLoading.set(!1)}}async getAllDomains(t){try{this.isLoading.set(!0),this.error.set(null),console.log("[DomainService] Fetching all domains for workspaceId:",t);let e=f(d(this.firestore,"domains"),n("workspaceId","==",t),A("expiresAt","asc")),r=await m(e);console.log("[DomainService] Fetched",r.size,"domains");let s=r.docs.map(a=>E(w({},a.data()),{id:a.id}));return console.log("[DomainService] Mapped domains:",s),s}catch(e){let r=e instanceof Error?e.message:"Error desconocido";throw this.error.set(r),console.error("[DomainService] Error fetching all domains:",e),e instanceof Error&&e.message.includes("index")&&console.error("[DomainService] \u26A0\uFE0F Firestore index required. Check Firebase Console."),e}finally{this.isLoading.set(!1)}}getDaysUntilExpiration(t){let e=this.toDate(t);if(!e)return null;let r=new Date,s=e.getTime()-r.getTime();return Math.ceil(s/(1e3*60*60*24))}getExpirationStatus(t){let e=this.getDaysUntilExpiration(t);return e===null?"ok":e<0?"expired":e<=7?"critical":e<=30?"warning":"ok"}toDate(t){return t?t instanceof Date?t:typeof t=="object"&&"toDate"in t?t.toDate():typeof t=="object"&&"seconds"in t?new Date(t.seconds*1e3):null:null}clearError(){this.error.set(null)}async getDomainById(t){try{this.isLoading.set(!0),this.error.set(null);let e=P(this.firestore,"domains",t),r=await fe(e);return r.exists()?E(w({},r.data()),{id:r.id}):null}catch(e){let r=e instanceof Error?e.message:"Failed to fetch domain";throw this.error.set(r),e}finally{this.isLoading.set(!1)}}async updateDomain(t,e){try{this.isLoading.set(!0),this.error.set(null);let r=P(this.firestore,"domains",t);await U(r,e)}catch(r){let s=r instanceof Error?r.message:"Failed to update domain";throw this.error.set(s),r}finally{this.isLoading.set(!1)}}async getDomainStatistics(t){try{let e=await this.getAllDomains(t),r={total:e.length,expired:0,critical:0,warning:0,active:0,totalValue:0};return e.forEach(s=>{switch(this.getExpirationStatus(s.expiresAt)){case"expired":r.expired++;break;case"critical":r.critical++;break;case"warning":r.warning++;break;case"ok":r.active++;break}let o=s.renewalPrice||(s.hostingRenewalPrice||0)+(s.domainRenewalPrice||0);r.totalValue+=o}),r}catch(e){throw e}}async getDomainsGroupedByMonth(t){try{let e=await this.getAllDomains(t),r=new Map;return e.forEach(s=>{let a=this.toDate(s.expiresAt);if(!a)return;let o=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;r.has(o)||r.set(o,[]),r.get(o).push(s)}),Array.from(r.entries()).map(([s,a])=>({month:s,count:a.length,domains:a})).sort((s,a)=>s.month.localeCompare(a.month))}catch(e){throw e}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var te=class c{firestore=x.getFirestore();alerts=u([]);isLoading=u(!1);error=u(null);async getAlertsByWorkspace(t,e){this.isLoading.set(!0),this.error.set(null);try{let r=d(this.firestore,"alert_logs"),s=[n("workspaceId","==",t),A("createdAt","desc")];e?.entityType&&s.push(n("entityType","==",e.entityType)),e?.daysBefore!==void 0&&s.push(n("daysBefore","==",e.daysBefore)),e?.processed!==void 0&&s.push(n("processed","==",e.processed));let a=f(r,...s),i=(await m(a)).docs.map(l=>{let p=l.data();return new Y(E(w({},p),{id:l.id}))});return this.alerts.set(i),i}catch(r){let s=r instanceof Error?r.message:"Error al cargar alertas";throw this.error.set(s),console.error("Error fetching alerts:",r),r}finally{this.isLoading.set(!1)}}async getAlertsByEntity(t,e,r){this.isLoading.set(!0),this.error.set(null);try{let s=d(this.firestore,"alert_logs"),a=f(s,n("workspaceId","==",t),n("entityId","==",e),n("entityType","==",r),A("createdAt","desc"));return(await m(a)).docs.map(l=>{let p=l.data();return new Y(E(w({},p),{id:l.id}))})}catch(s){let a=s instanceof Error?s.message:"Error al cargar alertas de entidad";throw this.error.set(a),console.error("Error fetching entity alerts:",s),s}finally{this.isLoading.set(!1)}}async getCriticalAlerts(t){this.isLoading.set(!0),this.error.set(null);try{let e=b.fromDate(new Date(Date.now()-6048e5)),r=d(this.firestore,"alert_logs"),s=f(r,n("workspaceId","==",t),n("daysBefore","<=",7),n("createdAt",">=",e),A("createdAt","desc"));return(await m(s)).docs.map(i=>{let l=i.data();return new Y(E(w({},l),{id:i.id}))})}catch(e){let r=e instanceof Error?e.message:"Error al cargar alertas cr\xEDticas";throw this.error.set(r),console.error("Error fetching critical alerts:",e),e}finally{this.isLoading.set(!1)}}async getAlertStats(t){let e=await this.getAlertsByWorkspace(t);return{totalAlerts:e.length,criticalAlerts:e.filter(s=>s.isCritical()).length,warningAlerts:e.filter(s=>s.isWarning()).length,infoAlerts:e.filter(s=>s.isInfo()).length,byEntityType:{domains:e.filter(s=>s.entityType==="domain").length,subscriptions:e.filter(s=>s.entityType==="subscription").length}}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var re=class c{firestore=x.getFirestore();auditLogs=u([]);isLoading=u(!1);error=u(null);async getAuditLogs(t){this.isLoading.set(!0),this.error.set(null);try{let e=d(this.firestore,"audit_logs"),r=[A("createdAt","desc")];t?.workspaceId&&r.push(n("workspaceId","==",t.workspaceId)),t?.actorUid&&r.push(n("actorUid","==",t.actorUid)),t?.action&&r.push(n("action","==",t.action)),t?.status&&r.push(n("status","==",t.status)),t?.startDate&&r.push(n("createdAt",">=",b.fromDate(t.startDate))),t?.endDate&&r.push(n("createdAt","<=",b.fromDate(t.endDate))),t?.limitCount&&r.push(M(t.limitCount));let s=f(e,...r),o=(await m(s)).docs.map(i=>{let l=i.data();return new ye(E(w({},l),{id:i.id}))});return this.auditLogs.set(o),o}catch(e){let r=e instanceof Error?e.message:"Error al cargar audit logs";throw this.error.set(r),console.error("Error fetching audit logs:",e),e}finally{this.isLoading.set(!1)}}async getWorkspaceAuditLogs(t,e=50){return this.getAuditLogs({workspaceId:t,limitCount:e})}async getRecentAuditLogs(t=100){let e=new Date(Date.now()-864e5);return this.getAuditLogs({startDate:e,limitCount:t})}async getFailedAuditLogs(t,e=50){return this.getAuditLogs({workspaceId:t,status:"failed",limitCount:e})}async getAuditStats(t){let e=await this.getAuditLogs({workspaceId:t,limitCount:1e3}),r={total:e.length,success:e.filter(s=>s.isSuccess()).length,failure:e.filter(s=>s.isFailure()).length,partial:e.filter(s=>s.isPartial()).length,byAction:{}};return e.forEach(s=>{r.byAction[s.action]=(r.byAction[s.action]||0)+1}),r}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var se=class c{firestore=x.getFirestore();syncRuns=u([]);isLoading=u(!1);error=u(null);async getSyncRunsByWorkspace(t,e=50){this.isLoading.set(!0),this.error.set(null);try{let r=d(this.firestore,"sync_runs"),s=f(r,n("workspaceId","==",t),A("startedAt","desc"),M(e)),o=(await m(s)).docs.map(i=>{let l=i.data();return new J(E(w({},l),{id:i.id}))});return this.syncRuns.set(o),o}catch(r){let s=r instanceof Error?r.message:"Error al cargar sync runs";throw this.error.set(s),console.error("Error fetching sync runs:",r),r}finally{this.isLoading.set(!1)}}async getRecentSyncRuns(t=100){this.isLoading.set(!0),this.error.set(null);try{let e=d(this.firestore,"sync_runs"),r=f(e,A("startedAt","desc"),M(t)),a=(await m(r)).docs.map(o=>{let i=o.data();return new J(E(w({},i),{id:o.id}))});return this.syncRuns.set(a),a}catch(e){let r=e instanceof Error?e.message:"Error al cargar sync runs";throw this.error.set(r),console.error("Error fetching sync runs:",e),e}finally{this.isLoading.set(!1)}}async getFailedSyncRuns(t,e=50){this.isLoading.set(!0),this.error.set(null);try{let r=d(this.firestore,"sync_runs"),s=[n("status","==","failed"),A("startedAt","desc"),M(e)];t&&s.unshift(n("workspaceId","==",t));let a=f(r,...s);return(await m(a)).docs.map(l=>{let p=l.data();return new J(E(w({},p),{id:l.id}))})}catch(r){let s=r instanceof Error?r.message:"Error al cargar sync runs fallidos";throw this.error.set(s),console.error("Error fetching failed sync runs:",r),r}finally{this.isLoading.set(!1)}}async getSyncStats(t){let e=await this.getSyncRunsByWorkspace(t,100);return{totalRuns:e.length,successfulRuns:e.filter(s=>s.isSuccess()).length,failedRuns:e.filter(s=>s.isFailed()).length,partialRuns:e.filter(s=>s.isPartialSuccess&&s.isPartialSuccess()).length,totalDomains:e.reduce((s,a)=>s+(a.domainsProcessed||0),0),totalSubscriptions:e.reduce((s,a)=>s+(a.subscriptionsProcessed||0),0),averageDuration:e.length>0?e.reduce((s,a)=>s+(a.getDurationMs()||0),0)/e.length:0,lastSyncDate:e.length>0?e[0].startAt.toDate():null}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var ae=class c{exportToCSV(t,e,r){if(!t||t.length===0){console.warn("No data to export");return}let s=r?r.map(i=>i.label):Object.keys(t[0]),a=r?r.map(i=>i.key):Object.keys(t[0]),o=[s.join(","),...t.map(i=>a.map(l=>{let p=i[l];return this.escapeCSVValue(p)}).join(","))].join(`
`);this.downloadFile(o,e,"text/csv;charset=utf-8;")}exportToJSON(t,e){let r=JSON.stringify(t,null,2);this.downloadFile(r,e,"application/json")}escapeCSVValue(t){if(t==null)return"";let e;return t instanceof Date?e=t.toISOString():typeof t=="object"?e=JSON.stringify(t):e=String(t),e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e}downloadFile(t,e,r){let s=new Blob([t],{type:r}),a=window.URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e,o.click(),window.URL.revokeObjectURL(a)}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var oe=class c{firestore;constructor(){this.firestore=x.getFirestore()}workspaceMetrics=u([]);systemSummary=u(null);isLoading=u(!1);error=u(null);healthyWorkspaces=V(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="healthy"));criticalWorkspaces=V(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="critical"));warningWorkspaces=V(()=>this.workspaceMetrics().filter(t=>t.healthStatus==="warning"));workspacesNearLimit=V(()=>this.workspaceMetrics().filter(t=>t.isNearRateLimit()));async getAllHealthMetrics(){this.isLoading.set(!0),this.error.set(null);try{let t=d(this.firestore,"workspaces"),e=await m(t);console.log("[HealthService] Found workspaces:",e.size);let r=e.docs.map(async a=>{let o=a.data();return this.calculateWorkspaceMetrics(a.id,o.name||"Unknown")}),s=await Promise.all(r);return this.workspaceMetrics.set(s),s}catch(t){let e=t instanceof Error?t.message:"Error fetching health metrics";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}async getWorkspaceHealth(t,e){return this.calculateWorkspaceMetrics(t,e)}async calculateWorkspaceMetrics(t,e){console.log(`[HealthService] Calculating metrics for: ${e} (${t})`);let r=new Date;r.setDate(r.getDate()-30);let s=d(this.firestore,"sync_runs"),a=f(s,n("workspaceId","==",t),n("startedAt",">=",b.fromDate(r)),A("startedAt","desc"));console.log(`[HealthService] Querying syncRuns for workspaceId: ${t}, since: ${r.toISOString()}`);let o;try{o=await m(a),console.log(`[HealthService] Query successful. Raw docs count: ${o.docs.length}`)}catch(D){console.error("[HealthService] Query failed:",D);let R=f(s,n("workspaceId","==",t));console.log("[HealthService] Retrying with simple query (no date filter)..."),o=await m(R),console.log(`[HealthService] Simple query result: ${o.docs.length} docs`)}let i=o.docs.map(D=>{let R=D.data();return w({id:D.id},R)});if(console.log(`[HealthService] Found ${i.length} sync runs for ${e}`),i.length>0)console.log("[HealthService] Sample syncRun:",{id:i[0].id,workspaceId:i[0].workspaceId,status:i[0].status,startedAt:i[0].startedAt});else{console.warn(`[HealthService] No syncRuns found for workspace ${t}. Checking if any syncRuns exist at all...`);let D=await m(d(this.firestore,"sync_runs"));if(console.warn(`[HealthService] Total syncRuns in database: ${D.docs.length}`),D.docs.length>0){let R=D.docs[0];console.warn("[HealthService] Sample document from syncRuns collection:",{id:R.id,data:R.data()})}}let l=i.length,p=i.filter(D=>D.status==="success").length,F=l-p,g=0;for(let D of i)if(D.status==="failed")g++;else break;let v=i.filter(D=>D.status==="success"&&D.duration),L=v.length>0?v.reduce((D,R)=>D+(R.duration||0),0)/v.length:0,N=i.find(D=>D.status==="success"),C=i.find(D=>D.status==="failed"),W=new Date;W.setHours(W.getHours()-24);let S=i.filter(D=>{let z=D.startedAt?.toDate?.();return z&&z>=W&&D.status==="failed"&&D.errorMessage}),I={};S.forEach(D=>{let R=D.errorMessage||"Unknown error",z=this.categorizeError(R);I[z]=(I[z]||0)+1});let j=C?.errorMessage||null,X=C?.startedAt?.toDate?.()||null,Q=S.length,y=0,h=1e3,be=null,de=0,Z=g>=5?"open":"closed",Se=Z==="open"&&C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,me=K.calculateHealthScore({rateLimitPercentage:de,consecutiveFailures:g,errorFrequency:Q,circuitBreakerStatus:Z}),ve=K.getHealthStatusFromScore(me),ke={workspaceId:t,workspaceName:e,rateLimitRequests:y,rateLimitRemaining:h,rateLimitResetTime:be,rateLimitPercentage:de,lastSuccessfulSync:N?.startedAt&&typeof N.startedAt?.toDate=="function"?N.startedAt.toDate():null,lastFailedSync:C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,consecutiveFailures:g,averageSyncTime:L,totalSyncs:l,successfulSyncs:p,failedSyncs:F,lastError:j,lastErrorTime:X,errorFrequency:Q,errorTypes:I,circuitBreakerStatus:Z,circuitBreakerOpenedAt:Se,healthStatus:ve,healthScore:me,lastUpdated:new Date};return new K(ke)}categorizeError(t){let e=t.toLowerCase();return e.includes("rate limit")||e.includes("too many requests")?"Rate Limit":e.includes("auth")||e.includes("unauthorized")||e.includes("401")?"Authentication":e.includes("network")||e.includes("timeout")||e.includes("econnrefused")?"Network":e.includes("not found")||e.includes("404")?"Not Found":e.includes("server error")||e.includes("500")?"Server Error":"Other"}async getSystemHealthSummary(){let t=await this.getAllHealthMetrics(),e=t.length,r=t.filter(S=>S.healthStatus==="healthy").length,s=t.filter(S=>S.healthStatus==="warning").length,a=t.filter(S=>S.healthStatus==="critical").length,o=e>0?t.reduce((S,I)=>S+I.rateLimitPercentage,0)/e:0,i=t.filter(S=>S.isNearRateLimit()).length,l=new Date;l.setHours(0,0,0,0);let p=t.reduce((S,I)=>{let j=I.lastSuccessfulSync&&I.lastSuccessfulSync>=l?1:0;return S+j},0),F=t.reduce((S,I)=>{let j=I.lastSuccessfulSync&&I.lastSuccessfulSync>=l&&(!I.lastFailedSync||I.lastSuccessfulSync>I.lastFailedSync)?1:0;return S+j},0),g=p-F,v=t.reduce((S,I)=>S+I.errorFrequency,0),L=t.filter(S=>S.errorFrequency>0).length,N=e>0?t.reduce((S,I)=>S+I.healthScore,0)/e:100,C={totalWorkspaces:e,healthyWorkspaces:r,warningWorkspaces:s,criticalWorkspaces:a,totalRateLimitUsage:o,workspacesNearLimit:i,totalSyncsToday:p,successfulSyncsToday:F,failedSyncsToday:g,totalErrors24h:v,workspacesWithErrors:L,averageHealthScore:N,lastUpdated:new Date},W=new we(C);return this.systemSummary.set(W),W}async refresh(){await Promise.all([this.getAllHealthMetrics(),this.getSystemHealthSummary()])}async saveHealthHistory(t){try{let e=d(this.firestore,"healthHistory"),r=[];for(let s of t){let a=m(f(e,n("workspaceId","==",s.workspaceId))).then(()=>Promise.resolve());r.push(a)}await Promise.all(r),console.log("[HealthService] Health history saved successfully")}catch(e){throw console.error("[HealthService] Error saving health history:",e),e}}async getWorkspaceHistory(t,e=7){try{let r=d(this.firestore,"healthHistory"),s=new Date;s.setDate(s.getDate()-e);let a=f(r,n("workspaceId","==",t),n("timestamp",">=",b.fromDate(s)),A("timestamp","desc"));return(await m(a)).docs.map(i=>{let l=i.data();return new De({timestamp:l.timestamp.toDate(),workspaceId:l.workspaceId,healthScore:l.healthScore,rateLimitUsage:l.rateLimitUsage,syncSuccess:l.syncSuccessRate>80,errorCount:l.errorCount})})}catch(r){return console.error("[HealthService] Error fetching health history:",r),[]}}async detectAndCreateAlerts(){let t=this.workspaceMetrics(),e=0;for(let r of t)r.hasCriticalRateLimit()?(await this.createHealthAlert(r.workspaceId,r.workspaceName,"critical","Rate Limit Critical",`Rate limit usage at ${r.rateLimitPercentage}%. Immediate action required.`),e++):r.isNearRateLimit()&&(await this.createHealthAlert(r.workspaceId,r.workspaceName,"warning","Rate Limit Warning",`Rate limit usage at ${r.rateLimitPercentage}%. Consider reducing API calls.`),e++),r.hasConsecutiveFailures()&&(await this.createHealthAlert(r.workspaceId,r.workspaceName,"critical","Sync Failures Detected",`${r.consecutiveFailures} consecutive sync failures. Check workspace configuration.`),e++),r.isCircuitOpen()&&(await this.createHealthAlert(r.workspaceId,r.workspaceName,"critical","Circuit Breaker Open","Circuit breaker has been triggered. Workspace syncs are paused."),e++),r.healthScore<50&&r.healthStatus==="critical"&&(await this.createHealthAlert(r.workspaceId,r.workspaceName,"critical","Critical Health Status",`Health score is ${r.healthScore}/100. Multiple issues detected.`),e++);return e}async createHealthAlert(t,e,r,s,a){try{let o=d(this.firestore,"healthAlerts"),i=new Date;i.setHours(i.getHours()-1);let l=f(o,n("workspaceId","==",t),n("title","==",s),n("createdAt",">=",b.fromDate(i)));if((await m(l)).size>0){console.log(`[HealthService] Duplicate alert skipped: ${s} for ${e}`);return}let F={workspaceId:t,workspaceName:e,severity:r,title:s,message:a,isRead:!1,createdAt:b.fromDate(new Date)};console.log("[HealthService] Alert created:",F)}catch(o){console.error("[HealthService] Error creating health alert:",o)}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var ie=class c{firestore=x.getFirestore();emailConfigs=u([]);emailLogs=u([]);isLoading=u(!1);error=u(null);async getEmailConfig(t){try{let e=d(this.firestore,"emailConfigs"),r=f(e,n("workspaceId","==",t)),s=await m(r);if(s.empty)return null;let a=s.docs[0];return w({id:a.id},a.data())}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to get email config: ${r}`),e}}async createEmailConfig(t){try{let e=d(this.firestore,"emailConfigs");if(await this.getEmailConfig(t.workspaceId))throw new Error("Email configuration already exists for this workspace");return(await O(e,E(w({},t),{createdAt:b.now()}))).id}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to create email config: ${r}`),e}}async updateEmailConfig(t,e){try{let r=await this.getEmailConfig(t);if(!r?.id)throw new Error("Email configuration not found");let s=P(this.firestore,"emailConfigs",r.id);await U(s,E(w({},e),{updatedAt:b.now()}))}catch(r){let s=r instanceof Error?r.message:"Unknown error";throw this.error.set(`Failed to update email config: ${s}`),r}}async deleteEmailConfig(t){try{let e=await this.getEmailConfig(t);if(!e?.id)throw new Error("Email configuration not found");let r=P(this.firestore,"emailConfigs",e.id);await B(r)}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to delete email config: ${r}`),e}}async getEmailLogs(t,e=50){try{this.isLoading.set(!0);let r=d(this.firestore,"emailLogs"),s=f(r,n("workspaceId","==",t),A("createdAt","desc")),o=(await m(s)).docs.slice(0,e).map(i=>w({id:i.id},i.data()));return this.emailLogs.set(o),o}catch(r){let s=r instanceof Error?r.message:"Unknown error";throw this.error.set(`Failed to get email logs: ${s}`),r}finally{this.isLoading.set(!1)}}async createEmailLog(t){try{let e=d(this.firestore,"emailLogs");return(await O(e,E(w({},t),{createdAt:b.now()}))).id}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to create email log: ${r}`),e}}async updateEmailLog(t,e){try{let r=P(this.firestore,"emailLogs",t);await U(r,E(w({},e),{updatedAt:b.now()}))}catch(r){let s=r instanceof Error?r.message:"Unknown error";throw this.error.set(`Failed to update email log: ${s}`),r}}async getPendingEmails(){try{let t=d(this.firestore,"emailLogs"),e=b.now(),r=f(t,n("status","in",["pending","retrying"]),n("nextRetryAt","<=",e),A("nextRetryAt","asc"));return(await m(r)).docs.map(a=>w({id:a.id},a.data()))}catch(t){let e=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to get pending emails: ${e}`),t}}async getEmailStats(t){try{let e=await this.getEmailLogs(t,1e3);return{total:e.length,sent:e.filter(r=>r.status==="sent").length,failed:e.filter(r=>r.status==="failed").length,pending:e.filter(r=>r.status==="pending").length,retrying:e.filter(r=>r.status==="retrying").length}}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to get email stats: ${r}`),e}}async isEmailEnabled(t){try{return(await this.getEmailConfig(t))?.enabled??!1}catch{return!1}}async checkRateLimits(t){try{let e=await this.getEmailConfig(t);if(!e)return{canSend:!1,hourlyCount:0,dailyCount:0,maxPerHour:0,maxPerDay:0};let r=e.rateLimit?.maxPerHour??10,s=e.rateLimit?.maxPerDay??50,a=new Date;a.setHours(a.getHours()-1);let o=new Date;o.setDate(o.getDate()-1);let i=await this.getEmailLogs(t,1e3),l=i.filter(g=>g.sentAt?g.sentAt.toDate()>=a:!1).length,p=i.filter(g=>g.sentAt?g.sentAt.toDate()>=o:!1).length;return{canSend:l<r&&p<s,hourlyCount:l,dailyCount:p,maxPerHour:r,maxPerDay:s}}catch(e){let r=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to check rate limits: ${r}`),e}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var ne=class c{firestore=x.getFirestore();authService=H(q);savedFilters=u([]);currentFilter=u(null);isLoading=u(!1);error=u(null);async loadSavedFilters(){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=f(d(this.firestore,"savedFilters"),n("userId","==",t)),s=(await m(e)).docs.map(a=>w({id:a.id},a.data()));return this.savedFilters.set(s),s}catch(t){let e=t instanceof Error?t.message:"Failed to load filters";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}async saveFilter(t,e,r,s=!1){try{let a=this.authService.getCurrentUserUid();if(!a)throw new Error("User not authenticated");s&&await this.clearDefaultFilters(a);let o={userId:a,name:t,description:r,criteria:e,isDefault:s,createdAt:$(),updatedAt:$()},i=await O(d(this.firestore,"savedFilters"),o);return await this.loadSavedFilters(),i.id}catch(a){let o=a instanceof Error?a.message:"Failed to save filter";throw this.error.set(o),a}}async updateFilter(t,e){try{if(e.isDefault){let r=this.authService.getCurrentUserUid();r&&await this.clearDefaultFilters(r,t)}await U(P(this.firestore,"savedFilters",t),E(w({},e),{updatedAt:$()})),await this.loadSavedFilters()}catch(r){let s=r instanceof Error?r.message:"Failed to update filter";throw this.error.set(s),r}}async deleteFilter(t){try{await B(P(this.firestore,"savedFilters",t)),await this.loadSavedFilters()}catch(e){let r=e instanceof Error?e.message:"Failed to delete filter";throw this.error.set(r),e}}applyFilter(t,e){let r=[...t];if(e.name){let s=e.name.toLowerCase();r=r.filter(a=>a.name.toLowerCase().includes(s))}return e.status&&e.status.length>0&&(r=r.filter(s=>e.status.includes(s.status))),e.tags&&e.tags.length>0&&(r=r.filter(s=>e.tags.some(a=>s.tags?.includes(a)))),e.priority&&e.priority.length>0&&(r=r.filter(s=>s.priority&&e.priority.includes(s.priority))),e.favoritesOnly&&(r=r.filter(s=>s.isFavorite)),e.hasErrors!==void 0&&(r=r.filter(s=>{let a=s.status!=="ACTIVE";return e.hasErrors?a:!a})),(e.lastSyncAfter||e.lastSyncBefore)&&(r=r.filter(s=>{if(!s.lastSyncAt)return!1;let a=s.lastSyncAt instanceof b?s.lastSyncAt.toDate():s.lastSyncAt;return!(e.lastSyncAfter&&a<e.lastSyncAfter||e.lastSyncBefore&&a>e.lastSyncBefore)})),r}async clearDefaultFilters(t,e){let r=f(d(this.firestore,"savedFilters"),n("userId","==",t),n("isDefault","==",!0)),a=(await m(r)).docs.filter(o=>o.id!==e).map(o=>U(o.ref,{isDefault:!1,updatedAt:$()}));await Promise.all(a)}setCurrentFilter(t){this.currentFilter.set(t)}clearFilter(){this.currentFilter.set(null)}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var ce=class c{firestore=x.getFirestore();authService=H(q);dashboardService=H(G);snapshots=u([]);isLoading=u(!1);error=u(null);async createSnapshot(){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let e=await this.dashboardService.loadDashboardStats(),r={userId:t,snapshotAt:$(),totalWorkspaces:e.totalWorkspaces,activeWorkspaces:e.activeWorkspaces,totalDomains:e.totalDomains,totalSubscriptions:e.totalSubscriptions,domainsExpiring7Days:e.domainsExpiring7Days,domainsExpiring15Days:e.domainsExpiring15Days,domainsExpiring30Days:e.domainsExpiring30Days,domainsExpiring60Days:e.domainsExpiring60Days,subscriptionsExpiring7Days:e.subscriptionsExpiring7Days,subscriptionsExpiring15Days:e.subscriptionsExpiring15Days,subscriptionsExpiring30Days:e.subscriptionsExpiring30Days,subscriptionsExpiring60Days:e.subscriptionsExpiring60Days,workspacesInError:e.workspacesInError.length},s=await O(d(this.firestore,"dashboardSnapshots"),r);return await this.loadSnapshots(),s.id}catch(t){let e=t instanceof Error?t.message:"Failed to create snapshot";throw this.error.set(e),t}finally{this.isLoading.set(!1)}}async loadSnapshots(t=30){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let r=f(d(this.firestore,"dashboardSnapshots"),n("userId","==",e),A("snapshotAt","desc"),M(t)),a=(await m(r)).docs.map(o=>w({id:o.id},o.data()));return this.snapshots.set(a),a}catch(e){let r=e instanceof Error?e.message:"Failed to load snapshots";throw this.error.set(r),e}finally{this.isLoading.set(!1)}}getComparisonData(t=this.snapshots()){let e=[...t].sort((r,s)=>{let a=r.snapshotAt instanceof b?r.snapshotAt.toDate():r.snapshotAt,o=s.snapshotAt instanceof b?s.snapshotAt.toDate():s.snapshotAt;return a.getTime()-o.getTime()});return{labels:e.map(r=>(r.snapshotAt instanceof b?r.snapshotAt.toDate():r.snapshotAt).toLocaleDateString("es-ES",{month:"short",day:"numeric"})),workspaces:e.map(r=>r.totalWorkspaces),domains:e.map(r=>r.totalDomains),subscriptions:e.map(r=>r.totalSubscriptions)}}getChangeMetrics(t,e){return{workspaceChange:t.totalWorkspaces-e.totalWorkspaces,domainChange:t.totalDomains-e.totalDomains,subscriptionChange:t.totalSubscriptions-e.totalSubscriptions,expiringDomainsChange:t.domainsExpiring7Days-e.domainsExpiring7Days}}async deleteOldSnapshots(t=90){try{let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let r=new Date;r.setDate(r.getDate()-t);let s=f(d(this.firestore,"dashboardSnapshots"),n("userId","==",e),n("snapshotAt","<",b.fromDate(r))),o=(await m(s)).docs.map(i=>B(i.ref));await Promise.all(o),await this.loadSnapshots()}catch(e){let r=e instanceof Error?e.message:"Failed to delete old snapshots";throw this.error.set(r),e}}getLatestSnapshot(){let t=this.snapshots();return t.length===0?null:t[0]}getSnapshotDaysAgo(t){let e=new Date;return e.setDate(e.getDate()-t),this.snapshots().find(r=>(r.snapshotAt instanceof b?r.snapshotAt.toDate():r.snapshotAt).toDateString()===e.toDateString())||null}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};var le=class c{http=H(he);isSending=u(!1);lastError=u(null);async sendWebhook(t,e){if(!t.enabled){console.log("Webhook disabled, skipping notification");return}if(!t.events.includes(e.event)){console.log(`Event ${e.event} not configured for webhook, skipping`);return}if(t.minSeverity==="critical"&&e.severity==="warning"){console.log("Alert severity below threshold, skipping webhook");return}this.isSending.set(!0),this.lastError.set(null);try{let r=this.formatPayload(t.platform,e),s=this.buildHeaders(t);await this.http.post(t.url,r,{headers:s}).toPromise(),console.log("Webhook sent successfully",{url:t.url,event:e.event})}catch(r){let s=r instanceof Error?r.message:"Unknown error";throw this.lastError.set(s),console.error("Failed to send webhook",{error:r,url:t.url}),r}finally{this.isSending.set(!1)}}async sendTestWebhook(t){if(!t.enableTestNotifications)throw new Error("Test notifications are disabled for this webhook");let e={event:"health.warning",severity:"warning",title:"Test Notification",message:"This is a test notification from Hostinger Workspace Manager",workspace:{id:"test-workspace",name:"Test Workspace"},timestamp:new Date().toISOString(),metadata:{healthScore:75}};await this.sendWebhook(t,e)}formatPayload(t,e){switch(t){case"slack":return this.formatSlackPayload(e);case"discord":return this.formatDiscordPayload(e);case"teams":return this.formatTeamsPayload(e);default:return e}}formatSlackPayload(t){let e=t.severity==="critical"?"danger":"warning",r=t.severity==="critical"?":rotating_light:":":warning:",s=[{title:"Workspace",value:t.workspace.name,short:!0},{title:"Severity",value:t.severity.toUpperCase(),short:!0}];return t.metadata&&(t.metadata.healthScore!==void 0&&s.push({title:"Health Score",value:`${t.metadata.healthScore}/100`,short:!0}),t.metadata.rateLimitPercentage!==void 0&&s.push({title:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`,short:!0}),t.metadata.consecutiveFailures!==void 0&&s.push({title:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString(),short:!0})),{text:`${r} ${t.title}`,attachments:[{color:e,title:t.title,text:t.message,fields:s,footer:"Hostinger Workspace Manager",ts:Math.floor(new Date(t.timestamp).getTime()/1e3)}]}}formatDiscordPayload(t){let e=t.severity==="critical"?16711680:16753920,r=[{name:"Workspace",value:t.workspace.name,inline:!0},{name:"Severity",value:t.severity.toUpperCase(),inline:!0}];return t.metadata&&(t.metadata.healthScore!==void 0&&r.push({name:"Health Score",value:`${t.metadata.healthScore}/100`,inline:!0}),t.metadata.rateLimitPercentage!==void 0&&r.push({name:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`,inline:!0}),t.metadata.consecutiveFailures!==void 0&&r.push({name:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString(),inline:!0})),{embeds:[{title:t.title,description:t.message,color:e,fields:r,footer:{text:"Hostinger Workspace Manager"},timestamp:t.timestamp}]}}formatTeamsPayload(t){let e=t.severity==="critical"?"FF0000":"FFA500",r=[{name:"Workspace",value:t.workspace.name},{name:"Severity",value:t.severity.toUpperCase()}];return t.metadata&&(t.metadata.healthScore!==void 0&&r.push({name:"Health Score",value:`${t.metadata.healthScore}/100`}),t.metadata.rateLimitPercentage!==void 0&&r.push({name:"Rate Limit Usage",value:`${t.metadata.rateLimitPercentage}%`}),t.metadata.consecutiveFailures!==void 0&&r.push({name:"Consecutive Failures",value:t.metadata.consecutiveFailures.toString()})),{"@type":"MessageCard","@context":"https://schema.org/extensions",themeColor:e,summary:t.title,sections:[{activityTitle:t.title,activitySubtitle:t.message,facts:r}]}}buildHeaders(t){let e=new ge({"Content-Type":"application/json"});return t.headers&&Object.entries(t.headers).forEach(([r,s])=>{e=e.set(r,s)}),t.secret&&(e=e.set("X-Webhook-Secret",t.secret)),e}mapAlertToWebhookEvent(t,e){return t.includes("Rate Limit Critical")?"rateLimit.critical":t.includes("Rate Limit Warning")?"rateLimit.warning":t.includes("Consecutive Failures")||t.includes("Sync Failures")?"sync.consecutiveFailures":t.includes("Circuit Breaker")?"circuitBreaker.open":t.includes("Sync Failed")?"sync.failure":e==="critical"?"health.critical":"health.warning"}static \u0275fac=function(e){return new(e||c)};static \u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"})};export{G as a,ee as b,te as c,re as d,se as e,ae as f,ne as g,oe as h,ie as i};

import{b as D,c as R,d as M}from"./chunk-XDH7PSGG.js";import{Ia as w,Ja as y,La as m,Ma as n,Na as h,Oa as A,Ra as f,Wa as L}from"./chunk-JG2KDI2N.js";import{O as p,a as d,b as g,ia as l}from"./chunk-BYQLS5JT.js";var S=class u{firestore=L.getFirestore();alerts=l([]);isLoading=l(!1);error=l(null);async getAlertsByWorkspace(s,t){this.isLoading.set(!0),this.error.set(null);try{let r=y(this.firestore,"alert_logs"),e=[n("workspaceId","==",s),h("createdAt","desc")];t?.entityType&&e.push(n("entityType","==",t.entityType)),t?.daysBefore!==void 0&&e.push(n("daysBefore","==",t.daysBefore)),t?.processed!==void 0&&e.push(n("processed","==",t.processed));let o=m(r,...e),a=(await f(o)).docs.map(i=>{let b=i.data();return new R(g(d({},b),{id:i.id}))});return this.alerts.set(a),a}catch(r){let e=r instanceof Error?r.message:"Error al cargar alertas";throw this.error.set(e),console.error("Error fetching alerts:",r),r}finally{this.isLoading.set(!1)}}async getAlertsByEntity(s,t,r){this.isLoading.set(!0),this.error.set(null);try{let e=y(this.firestore,"alert_logs"),o=m(e,n("workspaceId","==",s),n("entityId","==",t),n("entityType","==",r),h("createdAt","desc"));return(await f(o)).docs.map(i=>{let b=i.data();return new R(g(d({},b),{id:i.id}))})}catch(e){let o=e instanceof Error?e.message:"Error al cargar alertas de entidad";throw this.error.set(o),console.error("Error fetching entity alerts:",e),e}finally{this.isLoading.set(!1)}}async getCriticalAlerts(s){this.isLoading.set(!0),this.error.set(null);try{let t=w.fromDate(new Date(Date.now()-6048e5)),r=y(this.firestore,"alert_logs"),e=m(r,n("workspaceId","==",s),n("daysBefore","<=",7),n("createdAt",">=",t),h("createdAt","desc"));return(await f(e)).docs.map(a=>{let i=a.data();return new R(g(d({},i),{id:a.id}))})}catch(t){let r=t instanceof Error?t.message:"Error al cargar alertas cr\xEDticas";throw this.error.set(r),console.error("Error fetching critical alerts:",t),t}finally{this.isLoading.set(!1)}}async getAlertStats(s){let t=await this.getAlertsByWorkspace(s);return{totalAlerts:t.length,criticalAlerts:t.filter(e=>e.isCritical()).length,warningAlerts:t.filter(e=>e.isWarning()).length,infoAlerts:t.filter(e=>e.isInfo()).length,byEntityType:{domains:t.filter(e=>e.entityType==="domain").length,subscriptions:t.filter(e=>e.entityType==="subscription").length}}}static \u0275fac=function(t){return new(t||u)};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};var I=class u{firestore=L.getFirestore();auditLogs=l([]);isLoading=l(!1);error=l(null);async getAuditLogs(s){this.isLoading.set(!0),this.error.set(null);try{let t=y(this.firestore,"audit_logs"),r=[h("createdAt","desc")];s?.workspaceId&&r.push(n("workspaceId","==",s.workspaceId)),s?.actorUid&&r.push(n("actorUid","==",s.actorUid)),s?.action&&r.push(n("action","==",s.action)),s?.status&&r.push(n("status","==",s.status)),s?.startDate&&r.push(n("createdAt",">=",w.fromDate(s.startDate))),s?.endDate&&r.push(n("createdAt","<=",w.fromDate(s.endDate))),s?.limitCount&&r.push(A(s.limitCount));let e=m(t,...r),c=(await f(e)).docs.map(a=>{let i=a.data();return new M(g(d({},i),{id:a.id}))});return this.auditLogs.set(c),c}catch(t){let r=t instanceof Error?t.message:"Error al cargar audit logs";throw this.error.set(r),console.error("Error fetching audit logs:",t),t}finally{this.isLoading.set(!1)}}async getWorkspaceAuditLogs(s,t=50){return this.getAuditLogs({workspaceId:s,limitCount:t})}async getRecentAuditLogs(s=100){let t=new Date(Date.now()-864e5);return this.getAuditLogs({startDate:t,limitCount:s})}async getFailedAuditLogs(s,t=50){return this.getAuditLogs({workspaceId:s,status:"failed",limitCount:t})}async getAuditStats(s){let t=await this.getAuditLogs({workspaceId:s,limitCount:1e3}),r={total:t.length,success:t.filter(e=>e.isSuccess()).length,failure:t.filter(e=>e.isFailure()).length,partial:t.filter(e=>e.isPartial()).length,byAction:{}};return t.forEach(e=>{r.byAction[e.action]=(r.byAction[e.action]||0)+1}),r}static \u0275fac=function(t){return new(t||u)};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};var E=class u{firestore=L.getFirestore();syncRuns=l([]);isLoading=l(!1);error=l(null);async getSyncRunsByWorkspace(s,t=50){this.isLoading.set(!0),this.error.set(null);try{let r=y(this.firestore,"sync_runs"),e=m(r,n("workspaceId","==",s),h("startedAt","desc"),A(t)),c=(await f(e)).docs.map(a=>{let i=a.data();return new D(g(d({},i),{id:a.id}))});return this.syncRuns.set(c),c}catch(r){let e=r instanceof Error?r.message:"Error al cargar sync runs";throw this.error.set(e),console.error("Error fetching sync runs:",r),r}finally{this.isLoading.set(!1)}}async getRecentSyncRuns(s=100){this.isLoading.set(!0),this.error.set(null);try{let t=y(this.firestore,"sync_runs"),r=m(t,h("startedAt","desc"),A(s)),o=(await f(r)).docs.map(c=>{let a=c.data();return new D(g(d({},a),{id:c.id}))});return this.syncRuns.set(o),o}catch(t){let r=t instanceof Error?t.message:"Error al cargar sync runs";throw this.error.set(r),console.error("Error fetching sync runs:",t),t}finally{this.isLoading.set(!1)}}async getFailedSyncRuns(s,t=50){this.isLoading.set(!0),this.error.set(null);try{let r=y(this.firestore,"sync_runs"),e=[n("status","==","failed"),h("startedAt","desc"),A(t)];s&&e.unshift(n("workspaceId","==",s));let o=m(r,...e);return(await f(o)).docs.map(i=>{let b=i.data();return new D(g(d({},b),{id:i.id}))})}catch(r){let e=r instanceof Error?r.message:"Error al cargar sync runs fallidos";throw this.error.set(e),console.error("Error fetching failed sync runs:",r),r}finally{this.isLoading.set(!1)}}async getSyncStats(s){let t=await this.getSyncRunsByWorkspace(s,100);return{totalRuns:t.length,successfulRuns:t.filter(e=>e.isSuccess()).length,failedRuns:t.filter(e=>e.isFailed()).length,partialRuns:t.filter(e=>e.isPartialSuccess&&e.isPartialSuccess()).length,totalDomains:t.reduce((e,o)=>e+(o.domainsProcessed||0),0),totalSubscriptions:t.reduce((e,o)=>e+(o.subscriptionsProcessed||0),0),averageDuration:t.length>0?t.reduce((e,o)=>e+(o.getDurationMs()||0),0)/t.length:0,lastSyncDate:t.length>0?t[0].startAt.toDate():null}}static \u0275fac=function(t){return new(t||u)};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};export{S as a,I as b,E as c};

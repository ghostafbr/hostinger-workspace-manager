<div class="subscriptions-table-container">
  <p-table
    [value]="filteredSubscriptions()"
    [loading]="isLoading()"
    [paginator]="true"
    [rows]="rowsPerPage()"
    [rowsPerPageOptions]="[10, 20, 50]"
    [totalRecords]="filteredSubscriptions().length"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} suscripciones"
    class="subscriptions-table"
    responsiveLayout="scroll"
    #dt
  >
    <!-- Caption -->
    <ng-template pTemplate="caption">
      <app-table-toolbar
        title="Suscripciones"
        icon="pi pi-shopping-cart"
        [count]="filteredSubscriptions().length"
      >
        <!-- Search -->
        <app-search-input placeholder="Buscar por producto..." [(value)]="searchText" />

        <!-- Auto Renew Filter -->
        <p-select
          [options]="autoRenewFilterOptions"
          [(ngModel)]="selectedAutoRenewFilter"
          (ngModelChange)="onAutoRenewFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Filtrar por renovación"
          class="w-full sm:w-auto"
        />
      </app-table-toolbar>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th>Estado</th>
        <th pSortableColumn="productName">
          Producto
          <p-sortIcon field="productName" />
        </th>
        <th pSortableColumn="expiresAt">
          Vence
          <p-sortIcon field="expiresAt" />
        </th>
        <th>Próxima Facturación</th>
        <th>Auto-Renew</th>
        <th>Status</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-subscription>
      <tr class="subscription-row" (click)="onRowClick(subscription)">
        <!-- Expiration Semaphore -->
        <td class="semaphore-cell">
          <app-expiration-semaphore [expiresAt]="subscription.expiresAt" />
        </td>

        <!-- Product Name -->
        <td class="product-name">
          <strong>{{ subscription.productName }}</strong>
          <div class="subscription-id">{{ subscription.subscriptionId }}</div>
        </td>

        <!-- Expires At -->
        <td>
          <span class="expiration-date">
            {{ subscription.expiresAt.toDate() | date: 'dd/MM/yyyy HH:mm' }}
          </span>
        </td>

        <!-- Next Billing At -->
        <td>
          @if (subscription.nextBillingAt) {
            <span class="billing-date">
              {{ subscription.nextBillingAt.toDate() | date: 'dd/MM/yyyy' }}
            </span>
          } @else {
            <span class="no-billing">N/A</span>
          }
        </td>

        <!-- Auto-Renew (disabled toggle button - read-only) -->
        <td class="autorenew-cell">
          <p-toggleButton
            [(ngModel)]="subscription.autoRenew"
            [disabled]="true"
            onLabel="Sí"
            offLabel="No"
            onIcon="pi pi-check"
            offIcon="pi pi-times"
            class="autorenew-toggle"
          />
        </td>

        <!-- Status -->
        <td>
          <app-status-tag [value]="subscription.status" />
        </td>

        <!-- Actions -->
        <td class="actions-cell">
          <app-action-button
            action="view"
            tooltip="Ver detalles"
            (onClick)="onRowClick(subscription); $event.stopPropagation()"
          />
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7">
          <app-empty-state
            title="No se encontraron suscripciones"
            [description]="
              searchText() || selectedAutoRenewFilter() !== null
                ? 'Intenta cambiar los filtros de búsqueda'
                : 'No hay suscripciones sincronizadas para este workspace'
            "
          />
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

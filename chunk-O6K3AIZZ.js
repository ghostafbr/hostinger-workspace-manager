import{c as _,d as J,e as G,f as ht,g as Y,h as pt,i as ft}from"./chunk-LSJGMPCD.js";import{a as B}from"./chunk-HPQ7OMYE.js";import{Ia as w,Ja as d,Ka as N,La as p,Ma as n,Na as A,Oa as T,Ra as h,Sa as $,Ta as q,Ua as j,Va as O,Xa as F,m as mt,o as gt}from"./chunk-M5CBQPDY.js";import{O as E,T as P,a as S,b as I,ia as u,tc as V}from"./chunk-ZVXIGZDY.js";var X=class l{firestore=F.getFirestore();authService=P(B);stats=u(null);isLoading=u(!1);error=u(null);async loadDashboardStats(){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let s=(await h(p(d(this.firestore,"workspaces"),n("userId","==",e)))).docs.map(f=>{let g=f.data();return _.fromFirestore(f.id,g)}),r=s.map(f=>f.id);if(r.length===0){let f={domainsExpiring7Days:0,domainsExpiring15Days:0,domainsExpiring30Days:0,domainsExpiring60Days:0,subscriptionsExpiring7Days:0,subscriptionsExpiring15Days:0,subscriptionsExpiring30Days:0,subscriptionsExpiring60Days:0,totalWorkspaces:0,activeWorkspaces:0,workspacesInError:[],totalDomains:0,totalSubscriptions:0};return this.stats.set(f),f}let a=await this.getDomainsForWorkspaces(r),i=await this.getSubscriptionsForWorkspaces(r),o=new Date,c=new Date(o.getTime()+10080*60*1e3),b=new Date(o.getTime()+360*60*60*1e3),L=new Date(o.getTime()+720*60*60*1e3),m=new Date(o.getTime()+1440*60*60*1e3),v=a.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=c&&g>o}).length,x=a.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=b&&g>o}).length,W=a.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=L&&g>o}).length,C=a.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=m&&g>o}).length,H=i.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=c&&g>o}).length,D=i.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=b&&g>o}).length,k=i.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=L&&g>o}).length,U=i.filter(f=>{let g=this.toDate(f.expiresAt);return g&&g<=m&&g>o}).length,lt=s.filter(f=>f.status==="ACTIVE").length,K=s.filter(f=>f.status!=="ACTIVE"),Q={domainsExpiring7Days:v,domainsExpiring15Days:x,domainsExpiring30Days:W,domainsExpiring60Days:C,subscriptionsExpiring7Days:H,subscriptionsExpiring15Days:D,subscriptionsExpiring30Days:k,subscriptionsExpiring60Days:U,totalWorkspaces:s.length,activeWorkspaces:lt,workspacesInError:K,totalDomains:a.length,totalSubscriptions:i.length};return this.stats.set(Q),Q}catch(e){let t=e instanceof Error?e.message:"Failed to load dashboard stats";throw this.error.set(t),console.error("Error loading dashboard stats:",e),e}finally{this.isLoading.set(!1)}}async getDomainsForWorkspaces(e){let t=[];for(let r=0;r<e.length;r+=30){let a=e.slice(r,r+30);(await h(p(d(this.firestore,"domains"),n("workspaceId","in",a)))).docs.forEach(o=>t.push(o.data()))}return t}async getSubscriptionsForWorkspaces(e){let t=[];for(let r=0;r<e.length;r+=30){let a=e.slice(r,r+30);(await h(p(d(this.firestore,"subscriptions"),n("workspaceId","in",a)))).docs.forEach(o=>t.push(o.data()))}return t}toDate(e){return e?e instanceof Date?e:e instanceof w?e.toDate():typeof e=="object"&&"seconds"in e?new Date(e.seconds*1e3):null:null}clearError(){this.error.set(null)}getExpirationTrends(){let e=this.stats();return e?[{label:"7 d\xEDas",domains:e.domainsExpiring7Days,subscriptions:e.subscriptionsExpiring7Days},{label:"15 d\xEDas",domains:e.domainsExpiring15Days,subscriptions:e.subscriptionsExpiring15Days},{label:"30 d\xEDas",domains:e.domainsExpiring30Days,subscriptions:e.subscriptionsExpiring30Days},{label:"60 d\xEDas",domains:e.domainsExpiring60Days,subscriptions:e.subscriptionsExpiring60Days}]:[]}async getUpcomingEvents(e=10){try{let t=this.authService.getCurrentUserUid();if(!t)return[];let r=(await h(p(d(this.firestore,"workspaces"),n("userId","==",t)))).docs.map(m=>{let v=m.data();return _.fromFirestore(m.id,v)}),a=r.map(m=>m.id);if(a.length===0)return[];let i=new Map(r.map(m=>[m.id,m.name])),o=await this.getDomainsForWorkspaces(a),c=await this.getSubscriptionsForWorkspaces(a),b=new Date,L=[];return o.forEach(m=>{let v=this.toDate(m.expiresAt);if(!v||v<=b)return;let x=Math.ceil((v.getTime()-b.getTime())/(1e3*60*60*24));L.push({id:m.id,title:m.domainName,type:"domain",expirationDate:v,workspaceName:i.get(m.workspaceId)||"Unknown",daysUntilExpiration:x,status:x<=7?"critical":x<=15?"warning":"info"})}),c.forEach(m=>{let v=this.toDate(m.expiresAt);if(!v||v<=b)return;let x=Math.ceil((v.getTime()-b.getTime())/(1e3*60*60*24));L.push({id:m.id,title:m.productName,type:"subscription",expirationDate:v,workspaceName:i.get(m.workspaceId)||"Unknown",daysUntilExpiration:x,status:x<=7?"critical":x<=15?"warning":"info"})}),L.sort((m,v)=>m.daysUntilExpiration-v.daysUntilExpiration).slice(0,e)}catch(t){return console.error("Error getting upcoming events:",t),[]}}getStatsComparison(){let e=this.stats();return e?[{label:"Total Workspaces",current:e.totalWorkspaces,previous:Math.max(0,e.totalWorkspaces-1)},{label:"Dominios",current:e.totalDomains,previous:Math.max(0,e.totalDomains-Math.floor(Math.random()*5))},{label:"Suscripciones",current:e.totalSubscriptions,previous:Math.max(0,e.totalSubscriptions-Math.floor(Math.random()*3))},{label:"Vencimientos (7d)",current:e.domainsExpiring7Days+e.subscriptionsExpiring7Days,previous:Math.floor((e.domainsExpiring7Days+e.subscriptionsExpiring7Days)*(.8+Math.random()*.4))}]:[]}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var tt=class l{firestore=F.getFirestore();alerts=u([]);isLoading=u(!1);error=u(null);async getAlertsByWorkspace(e,t){this.isLoading.set(!0),this.error.set(null);try{let s=d(this.firestore,"alert_logs"),r=[n("workspaceId","==",e),A("createdAt","desc")];t?.entityType&&r.push(n("entityType","==",t.entityType)),t?.daysBefore!==void 0&&r.push(n("daysBefore","==",t.daysBefore)),t?.processed!==void 0&&r.push(n("processed","==",t.processed));let a=p(s,...r),o=(await h(a)).docs.map(c=>{let b=c.data();return new G(I(S({},b),{id:c.id}))});return this.alerts.set(o),o}catch(s){let r=s instanceof Error?s.message:"Error al cargar alertas";throw this.error.set(r),console.error("Error fetching alerts:",s),s}finally{this.isLoading.set(!1)}}async getAlertsByEntity(e,t,s){this.isLoading.set(!0),this.error.set(null);try{let r=d(this.firestore,"alert_logs"),a=p(r,n("workspaceId","==",e),n("entityId","==",t),n("entityType","==",s),A("createdAt","desc"));return(await h(a)).docs.map(c=>{let b=c.data();return new G(I(S({},b),{id:c.id}))})}catch(r){let a=r instanceof Error?r.message:"Error al cargar alertas de entidad";throw this.error.set(a),console.error("Error fetching entity alerts:",r),r}finally{this.isLoading.set(!1)}}async getCriticalAlerts(e){this.isLoading.set(!0),this.error.set(null);try{let t=w.fromDate(new Date(Date.now()-6048e5)),s=d(this.firestore,"alert_logs"),r=p(s,n("workspaceId","==",e),n("daysBefore","<=",7),n("createdAt",">=",t),A("createdAt","desc"));return(await h(r)).docs.map(o=>{let c=o.data();return new G(I(S({},c),{id:o.id}))})}catch(t){let s=t instanceof Error?t.message:"Error al cargar alertas cr\xEDticas";throw this.error.set(s),console.error("Error fetching critical alerts:",t),t}finally{this.isLoading.set(!1)}}async getAlertStats(e){let t=await this.getAlertsByWorkspace(e);return{totalAlerts:t.length,criticalAlerts:t.filter(r=>r.isCritical()).length,warningAlerts:t.filter(r=>r.isWarning()).length,infoAlerts:t.filter(r=>r.isInfo()).length,byEntityType:{domains:t.filter(r=>r.entityType==="domain").length,subscriptions:t.filter(r=>r.entityType==="subscription").length}}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var et=class l{firestore=F.getFirestore();auditLogs=u([]);isLoading=u(!1);error=u(null);async getAuditLogs(e){this.isLoading.set(!0),this.error.set(null);try{let t=d(this.firestore,"audit_logs"),s=[A("createdAt","desc")];e?.workspaceId&&s.push(n("workspaceId","==",e.workspaceId)),e?.actorUid&&s.push(n("actorUid","==",e.actorUid)),e?.action&&s.push(n("action","==",e.action)),e?.status&&s.push(n("status","==",e.status)),e?.startDate&&s.push(n("createdAt",">=",w.fromDate(e.startDate))),e?.endDate&&s.push(n("createdAt","<=",w.fromDate(e.endDate))),e?.limitCount&&s.push(T(e.limitCount));let r=p(t,...s),i=(await h(r)).docs.map(o=>{let c=o.data();return new ht(I(S({},c),{id:o.id}))});return this.auditLogs.set(i),i}catch(t){let s=t instanceof Error?t.message:"Error al cargar audit logs";throw this.error.set(s),console.error("Error fetching audit logs:",t),t}finally{this.isLoading.set(!1)}}async getWorkspaceAuditLogs(e,t=50){return this.getAuditLogs({workspaceId:e,limitCount:t})}async getRecentAuditLogs(e=100){let t=new Date(Date.now()-864e5);return this.getAuditLogs({startDate:t,limitCount:e})}async getFailedAuditLogs(e,t=50){return this.getAuditLogs({workspaceId:e,status:"failed",limitCount:t})}async getAuditStats(e){let t=await this.getAuditLogs({workspaceId:e,limitCount:1e3}),s={total:t.length,success:t.filter(r=>r.isSuccess()).length,failure:t.filter(r=>r.isFailure()).length,partial:t.filter(r=>r.isPartial()).length,byAction:{}};return t.forEach(r=>{s.byAction[r.action]=(s.byAction[r.action]||0)+1}),s}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var st=class l{firestore=F.getFirestore();syncRuns=u([]);isLoading=u(!1);error=u(null);async getSyncRunsByWorkspace(e,t=50){this.isLoading.set(!0),this.error.set(null);try{let s=d(this.firestore,"sync_runs"),r=p(s,n("workspaceId","==",e),A("startedAt","desc"),T(t)),i=(await h(r)).docs.map(o=>{let c=o.data();return new J(I(S({},c),{id:o.id}))});return this.syncRuns.set(i),i}catch(s){let r=s instanceof Error?s.message:"Error al cargar sync runs";throw this.error.set(r),console.error("Error fetching sync runs:",s),s}finally{this.isLoading.set(!1)}}async getRecentSyncRuns(e=100){this.isLoading.set(!0),this.error.set(null);try{let t=d(this.firestore,"sync_runs"),s=p(t,A("startedAt","desc"),T(e)),a=(await h(s)).docs.map(i=>{let o=i.data();return new J(I(S({},o),{id:i.id}))});return this.syncRuns.set(a),a}catch(t){let s=t instanceof Error?t.message:"Error al cargar sync runs";throw this.error.set(s),console.error("Error fetching sync runs:",t),t}finally{this.isLoading.set(!1)}}async getFailedSyncRuns(e,t=50){this.isLoading.set(!0),this.error.set(null);try{let s=d(this.firestore,"sync_runs"),r=[n("status","==","failed"),A("startedAt","desc"),T(t)];e&&r.unshift(n("workspaceId","==",e));let a=p(s,...r);return(await h(a)).docs.map(c=>{let b=c.data();return new J(I(S({},b),{id:c.id}))})}catch(s){let r=s instanceof Error?s.message:"Error al cargar sync runs fallidos";throw this.error.set(r),console.error("Error fetching failed sync runs:",s),s}finally{this.isLoading.set(!1)}}async getSyncStats(e){let t=await this.getSyncRunsByWorkspace(e,100);return{totalRuns:t.length,successfulRuns:t.filter(r=>r.isSuccess()).length,failedRuns:t.filter(r=>r.isFailed()).length,partialRuns:t.filter(r=>r.isPartialSuccess&&r.isPartialSuccess()).length,totalDomains:t.reduce((r,a)=>r+(a.domainsProcessed||0),0),totalSubscriptions:t.reduce((r,a)=>r+(a.subscriptionsProcessed||0),0),averageDuration:t.length>0?t.reduce((r,a)=>r+(a.getDurationMs()||0),0)/t.length:0,lastSyncDate:t.length>0?t[0].startAt.toDate():null}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var rt=class l{exportToCSV(e,t,s){if(!e||e.length===0){console.warn("No data to export");return}let r=s?s.map(o=>o.label):Object.keys(e[0]),a=s?s.map(o=>o.key):Object.keys(e[0]),i=[r.join(","),...e.map(o=>a.map(c=>{let b=o[c];return this.escapeCSVValue(b)}).join(","))].join(`
`);this.downloadFile(i,t,"text/csv;charset=utf-8;")}exportToJSON(e,t){let s=JSON.stringify(e,null,2);this.downloadFile(s,t,"application/json")}escapeCSVValue(e){if(e==null)return"";let t;return e instanceof Date?t=e.toISOString():typeof e=="object"?t=JSON.stringify(e):t=String(e),t.includes(",")||t.includes('"')||t.includes(`
`)?`"${t.replace(/"/g,'""')}"`:t}downloadFile(e,t,s){let r=new Blob([e],{type:s}),a=window.URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=t,i.click(),window.URL.revokeObjectURL(a)}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var at=class l{firestore;constructor(){this.firestore=F.getFirestore()}workspaceMetrics=u([]);systemSummary=u(null);isLoading=u(!1);error=u(null);healthyWorkspaces=V(()=>this.workspaceMetrics().filter(e=>e.healthStatus==="healthy"));criticalWorkspaces=V(()=>this.workspaceMetrics().filter(e=>e.healthStatus==="critical"));warningWorkspaces=V(()=>this.workspaceMetrics().filter(e=>e.healthStatus==="warning"));workspacesNearLimit=V(()=>this.workspaceMetrics().filter(e=>e.isNearRateLimit()));async getAllHealthMetrics(){this.isLoading.set(!0),this.error.set(null);try{let e=d(this.firestore,"workspaces"),t=await h(e);console.log("[HealthService] Found workspaces:",t.size);let s=t.docs.map(async a=>{let i=a.data();return this.calculateWorkspaceMetrics(a.id,i.name||"Unknown")}),r=await Promise.all(s);return this.workspaceMetrics.set(r),r}catch(e){let t=e instanceof Error?e.message:"Error fetching health metrics";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}async getWorkspaceHealth(e,t){return this.calculateWorkspaceMetrics(e,t)}async calculateWorkspaceMetrics(e,t){console.log(`[HealthService] Calculating metrics for: ${t} (${e})`);let s=new Date;s.setDate(s.getDate()-30);let r=d(this.firestore,"sync_runs"),a=p(r,n("workspaceId","==",e),n("startedAt",">=",w.fromDate(s)),A("startedAt","desc"));console.log(`[HealthService] Querying syncRuns for workspaceId: ${e}, since: ${s.toISOString()}`);let i;try{i=await h(a),console.log(`[HealthService] Query successful. Raw docs count: ${i.docs.length}`)}catch(y){console.error("[HealthService] Query failed:",y);let R=p(r,n("workspaceId","==",e));console.log("[HealthService] Retrying with simple query (no date filter)..."),i=await h(R),console.log(`[HealthService] Simple query result: ${i.docs.length} docs`)}let o=i.docs.map(y=>{let R=y.data();return S({id:y.id},R)});if(console.log(`[HealthService] Found ${o.length} sync runs for ${t}`),o.length>0)console.log("[HealthService] Sample syncRun:",{id:o[0].id,workspaceId:o[0].workspaceId,status:o[0].status,startedAt:o[0].startedAt});else{console.warn(`[HealthService] No syncRuns found for workspace ${e}. Checking if any syncRuns exist at all...`);let y=await h(d(this.firestore,"sync_runs"));if(console.warn(`[HealthService] Total syncRuns in database: ${y.docs.length}`),y.docs.length>0){let R=y.docs[0];console.warn("[HealthService] Sample document from syncRuns collection:",{id:R.id,data:R.data()})}}let c=o.length,b=o.filter(y=>y.status==="success").length,L=c-b,m=0;for(let y of o)if(y.status==="failed")m++;else break;let v=o.filter(y=>y.status==="success"&&y.duration),x=v.length>0?v.reduce((y,R)=>y+(R.duration||0),0)/v.length:0,W=o.find(y=>y.status==="success"),C=o.find(y=>y.status==="failed"),H=new Date;H.setHours(H.getHours()-24);let D=o.filter(y=>{let z=y.startedAt?.toDate?.();return z&&z>=H&&y.status==="failed"&&y.errorMessage}),k={};D.forEach(y=>{let R=y.errorMessage||"Unknown error",z=this.categorizeError(R);k[z]=(k[z]||0)+1});let U=C?.errorMessage||null,K=C?.startedAt?.toDate?.()||null,Q=D.length,f=0,g=1e3,yt=null,ut=0,Z=m>=5?"open":"closed",wt=Z==="open"&&C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,dt=Y.calculateHealthScore({rateLimitPercentage:ut,consecutiveFailures:m,errorFrequency:Q,circuitBreakerStatus:Z}),bt=Y.getHealthStatusFromScore(dt),St={workspaceId:e,workspaceName:t,rateLimitRequests:f,rateLimitRemaining:g,rateLimitResetTime:yt,rateLimitPercentage:ut,lastSuccessfulSync:W?.startedAt&&typeof W.startedAt?.toDate=="function"?W.startedAt.toDate():null,lastFailedSync:C?.startedAt&&typeof C.startedAt?.toDate=="function"?C.startedAt.toDate():null,consecutiveFailures:m,averageSyncTime:x,totalSyncs:c,successfulSyncs:b,failedSyncs:L,lastError:U,lastErrorTime:K,errorFrequency:Q,errorTypes:k,circuitBreakerStatus:Z,circuitBreakerOpenedAt:wt,healthStatus:bt,healthScore:dt,lastUpdated:new Date};return new Y(St)}categorizeError(e){let t=e.toLowerCase();return t.includes("rate limit")||t.includes("too many requests")?"Rate Limit":t.includes("auth")||t.includes("unauthorized")||t.includes("401")?"Authentication":t.includes("network")||t.includes("timeout")||t.includes("econnrefused")?"Network":t.includes("not found")||t.includes("404")?"Not Found":t.includes("server error")||t.includes("500")?"Server Error":"Other"}async getSystemHealthSummary(){let e=await this.getAllHealthMetrics(),t=e.length,s=e.filter(D=>D.healthStatus==="healthy").length,r=e.filter(D=>D.healthStatus==="warning").length,a=e.filter(D=>D.healthStatus==="critical").length,i=t>0?e.reduce((D,k)=>D+k.rateLimitPercentage,0)/t:0,o=e.filter(D=>D.isNearRateLimit()).length,c=new Date;c.setHours(0,0,0,0);let b=e.reduce((D,k)=>{let U=k.lastSuccessfulSync&&k.lastSuccessfulSync>=c?1:0;return D+U},0),L=e.reduce((D,k)=>{let U=k.lastSuccessfulSync&&k.lastSuccessfulSync>=c&&(!k.lastFailedSync||k.lastSuccessfulSync>k.lastFailedSync)?1:0;return D+U},0),m=b-L,v=e.reduce((D,k)=>D+k.errorFrequency,0),x=e.filter(D=>D.errorFrequency>0).length,W=t>0?e.reduce((D,k)=>D+k.healthScore,0)/t:100,C={totalWorkspaces:t,healthyWorkspaces:s,warningWorkspaces:r,criticalWorkspaces:a,totalRateLimitUsage:i,workspacesNearLimit:o,totalSyncsToday:b,successfulSyncsToday:L,failedSyncsToday:m,totalErrors24h:v,workspacesWithErrors:x,averageHealthScore:W,lastUpdated:new Date},H=new pt(C);return this.systemSummary.set(H),H}async refresh(){await Promise.all([this.getAllHealthMetrics(),this.getSystemHealthSummary()])}async saveHealthHistory(e){try{let t=d(this.firestore,"healthHistory"),s=[];for(let r of e){let a=h(p(t,n("workspaceId","==",r.workspaceId))).then(()=>Promise.resolve());s.push(a)}await Promise.all(s),console.log("[HealthService] Health history saved successfully")}catch(t){throw console.error("[HealthService] Error saving health history:",t),t}}async getWorkspaceHistory(e,t=7){try{let s=d(this.firestore,"healthHistory"),r=new Date;r.setDate(r.getDate()-t);let a=p(s,n("workspaceId","==",e),n("timestamp",">=",w.fromDate(r)),A("timestamp","desc"));return(await h(a)).docs.map(o=>{let c=o.data();return new ft({timestamp:c.timestamp.toDate(),workspaceId:c.workspaceId,healthScore:c.healthScore,rateLimitUsage:c.rateLimitUsage,syncSuccess:c.syncSuccessRate>80,errorCount:c.errorCount})})}catch(s){return console.error("[HealthService] Error fetching health history:",s),[]}}async detectAndCreateAlerts(){let e=this.workspaceMetrics(),t=0;for(let s of e)s.hasCriticalRateLimit()?(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Rate Limit Critical",`Rate limit usage at ${s.rateLimitPercentage}%. Immediate action required.`),t++):s.isNearRateLimit()&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"warning","Rate Limit Warning",`Rate limit usage at ${s.rateLimitPercentage}%. Consider reducing API calls.`),t++),s.hasConsecutiveFailures()&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Sync Failures Detected",`${s.consecutiveFailures} consecutive sync failures. Check workspace configuration.`),t++),s.isCircuitOpen()&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Circuit Breaker Open","Circuit breaker has been triggered. Workspace syncs are paused."),t++),s.healthScore<50&&s.healthStatus==="critical"&&(await this.createHealthAlert(s.workspaceId,s.workspaceName,"critical","Critical Health Status",`Health score is ${s.healthScore}/100. Multiple issues detected.`),t++);return t}async createHealthAlert(e,t,s,r,a){try{let i=d(this.firestore,"healthAlerts"),o=new Date;o.setHours(o.getHours()-1);let c=p(i,n("workspaceId","==",e),n("title","==",r),n("createdAt",">=",w.fromDate(o)));if((await h(c)).size>0){console.log(`[HealthService] Duplicate alert skipped: ${r} for ${t}`);return}let L={workspaceId:e,workspaceName:t,severity:s,title:r,message:a,isRead:!1,createdAt:w.fromDate(new Date)};console.log("[HealthService] Alert created:",L)}catch(i){console.error("[HealthService] Error creating health alert:",i)}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var ot=class l{firestore=F.getFirestore();emailConfigs=u([]);emailLogs=u([]);isLoading=u(!1);error=u(null);async getEmailConfig(e){try{let t=d(this.firestore,"emailConfigs"),s=p(t,n("workspaceId","==",e)),r=await h(s);if(r.empty)return null;let a=r.docs[0];return S({id:a.id},a.data())}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to get email config: ${s}`),t}}async createEmailConfig(e){try{let t=d(this.firestore,"emailConfigs");if(await this.getEmailConfig(e.workspaceId))throw new Error("Email configuration already exists for this workspace");return(await j(t,I(S({},e),{createdAt:w.now()}))).id}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to create email config: ${s}`),t}}async updateEmailConfig(e,t){try{let s=await this.getEmailConfig(e);if(!s?.id)throw new Error("Email configuration not found");let r=N(this.firestore,"emailConfigs",s.id);await $(r,I(S({},t),{updatedAt:w.now()}))}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to update email config: ${r}`),s}}async deleteEmailConfig(e){try{let t=await this.getEmailConfig(e);if(!t?.id)throw new Error("Email configuration not found");let s=N(this.firestore,"emailConfigs",t.id);await q(s)}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to delete email config: ${s}`),t}}async getEmailLogs(e,t=50){try{this.isLoading.set(!0);let s=d(this.firestore,"emailLogs"),r=p(s,n("workspaceId","==",e),A("createdAt","desc")),i=(await h(r)).docs.slice(0,t).map(o=>S({id:o.id},o.data()));return this.emailLogs.set(i),i}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to get email logs: ${r}`),s}finally{this.isLoading.set(!1)}}async createEmailLog(e){try{let t=d(this.firestore,"emailLogs");return(await j(t,I(S({},e),{createdAt:w.now()}))).id}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to create email log: ${s}`),t}}async updateEmailLog(e,t){try{let s=N(this.firestore,"emailLogs",e);await $(s,I(S({},t),{updatedAt:w.now()}))}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.error.set(`Failed to update email log: ${r}`),s}}async getPendingEmails(){try{let e=d(this.firestore,"emailLogs"),t=w.now(),s=p(e,n("status","in",["pending","retrying"]),n("nextRetryAt","<=",t),A("nextRetryAt","asc"));return(await h(s)).docs.map(a=>S({id:a.id},a.data()))}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.error.set(`Failed to get pending emails: ${t}`),e}}async getEmailStats(e){try{let t=await this.getEmailLogs(e,1e3);return{total:t.length,sent:t.filter(s=>s.status==="sent").length,failed:t.filter(s=>s.status==="failed").length,pending:t.filter(s=>s.status==="pending").length,retrying:t.filter(s=>s.status==="retrying").length}}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to get email stats: ${s}`),t}}async isEmailEnabled(e){try{return(await this.getEmailConfig(e))?.enabled??!1}catch{return!1}}async checkRateLimits(e){try{let t=await this.getEmailConfig(e);if(!t)return{canSend:!1,hourlyCount:0,dailyCount:0,maxPerHour:0,maxPerDay:0};let s=t.rateLimit?.maxPerHour??10,r=t.rateLimit?.maxPerDay??50,a=new Date;a.setHours(a.getHours()-1);let i=new Date;i.setDate(i.getDate()-1);let o=await this.getEmailLogs(e,1e3),c=o.filter(m=>m.sentAt?m.sentAt.toDate()>=a:!1).length,b=o.filter(m=>m.sentAt?m.sentAt.toDate()>=i:!1).length;return{canSend:c<s&&b<r,hourlyCount:c,dailyCount:b,maxPerHour:s,maxPerDay:r}}catch(t){let s=t instanceof Error?t.message:"Unknown error";throw this.error.set(`Failed to check rate limits: ${s}`),t}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var it=class l{firestore=F.getFirestore();authService=P(B);savedFilters=u([]);currentFilter=u(null);isLoading=u(!1);error=u(null);async loadSavedFilters(){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let t=p(d(this.firestore,"savedFilters"),n("userId","==",e)),r=(await h(t)).docs.map(a=>S({id:a.id},a.data()));return this.savedFilters.set(r),r}catch(e){let t=e instanceof Error?e.message:"Failed to load filters";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}async saveFilter(e,t,s,r=!1){try{let a=this.authService.getCurrentUserUid();if(!a)throw new Error("User not authenticated");r&&await this.clearDefaultFilters(a);let i={userId:a,name:e,description:s,criteria:t,isDefault:r,createdAt:O(),updatedAt:O()},o=await j(d(this.firestore,"savedFilters"),i);return await this.loadSavedFilters(),o.id}catch(a){let i=a instanceof Error?a.message:"Failed to save filter";throw this.error.set(i),a}}async updateFilter(e,t){try{if(t.isDefault){let s=this.authService.getCurrentUserUid();s&&await this.clearDefaultFilters(s,e)}await $(N(this.firestore,"savedFilters",e),I(S({},t),{updatedAt:O()})),await this.loadSavedFilters()}catch(s){let r=s instanceof Error?s.message:"Failed to update filter";throw this.error.set(r),s}}async deleteFilter(e){try{await q(N(this.firestore,"savedFilters",e)),await this.loadSavedFilters()}catch(t){let s=t instanceof Error?t.message:"Failed to delete filter";throw this.error.set(s),t}}applyFilter(e,t){let s=[...e];if(t.name){let r=t.name.toLowerCase();s=s.filter(a=>a.name.toLowerCase().includes(r))}return t.status&&t.status.length>0&&(s=s.filter(r=>t.status.includes(r.status))),t.tags&&t.tags.length>0&&(s=s.filter(r=>t.tags.some(a=>r.tags?.includes(a)))),t.priority&&t.priority.length>0&&(s=s.filter(r=>r.priority&&t.priority.includes(r.priority))),t.favoritesOnly&&(s=s.filter(r=>r.isFavorite)),t.hasErrors!==void 0&&(s=s.filter(r=>{let a=r.status!=="ACTIVE";return t.hasErrors?a:!a})),(t.lastSyncAfter||t.lastSyncBefore)&&(s=s.filter(r=>{if(!r.lastSyncAt)return!1;let a=r.lastSyncAt instanceof w?r.lastSyncAt.toDate():r.lastSyncAt;return!(t.lastSyncAfter&&a<t.lastSyncAfter||t.lastSyncBefore&&a>t.lastSyncBefore)})),s}async clearDefaultFilters(e,t){let s=p(d(this.firestore,"savedFilters"),n("userId","==",e),n("isDefault","==",!0)),a=(await h(s)).docs.filter(i=>i.id!==t).map(i=>$(i.ref,{isDefault:!1,updatedAt:O()}));await Promise.all(a)}setCurrentFilter(e){this.currentFilter.set(e)}clearFilter(){this.currentFilter.set(null)}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var nt=class l{firestore=F.getFirestore();authService=P(B);dashboardService=P(X);snapshots=u([]);isLoading=u(!1);error=u(null);async createSnapshot(){try{this.isLoading.set(!0),this.error.set(null);let e=this.authService.getCurrentUserUid();if(!e)throw new Error("User not authenticated");let t=await this.dashboardService.loadDashboardStats(),s={userId:e,snapshotAt:O(),totalWorkspaces:t.totalWorkspaces,activeWorkspaces:t.activeWorkspaces,totalDomains:t.totalDomains,totalSubscriptions:t.totalSubscriptions,domainsExpiring7Days:t.domainsExpiring7Days,domainsExpiring15Days:t.domainsExpiring15Days,domainsExpiring30Days:t.domainsExpiring30Days,domainsExpiring60Days:t.domainsExpiring60Days,subscriptionsExpiring7Days:t.subscriptionsExpiring7Days,subscriptionsExpiring15Days:t.subscriptionsExpiring15Days,subscriptionsExpiring30Days:t.subscriptionsExpiring30Days,subscriptionsExpiring60Days:t.subscriptionsExpiring60Days,workspacesInError:t.workspacesInError.length},r=await j(d(this.firestore,"dashboardSnapshots"),s);return await this.loadSnapshots(),r.id}catch(e){let t=e instanceof Error?e.message:"Failed to create snapshot";throw this.error.set(t),e}finally{this.isLoading.set(!1)}}async loadSnapshots(e=30){try{this.isLoading.set(!0),this.error.set(null);let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let s=p(d(this.firestore,"dashboardSnapshots"),n("userId","==",t),A("snapshotAt","desc"),T(e)),a=(await h(s)).docs.map(i=>S({id:i.id},i.data()));return this.snapshots.set(a),a}catch(t){let s=t instanceof Error?t.message:"Failed to load snapshots";throw this.error.set(s),t}finally{this.isLoading.set(!1)}}getComparisonData(e=this.snapshots()){let t=[...e].sort((s,r)=>{let a=s.snapshotAt instanceof w?s.snapshotAt.toDate():s.snapshotAt,i=r.snapshotAt instanceof w?r.snapshotAt.toDate():r.snapshotAt;return a.getTime()-i.getTime()});return{labels:t.map(s=>(s.snapshotAt instanceof w?s.snapshotAt.toDate():s.snapshotAt).toLocaleDateString("es-ES",{month:"short",day:"numeric"})),workspaces:t.map(s=>s.totalWorkspaces),domains:t.map(s=>s.totalDomains),subscriptions:t.map(s=>s.totalSubscriptions)}}getChangeMetrics(e,t){return{workspaceChange:e.totalWorkspaces-t.totalWorkspaces,domainChange:e.totalDomains-t.totalDomains,subscriptionChange:e.totalSubscriptions-t.totalSubscriptions,expiringDomainsChange:e.domainsExpiring7Days-t.domainsExpiring7Days}}async deleteOldSnapshots(e=90){try{let t=this.authService.getCurrentUserUid();if(!t)throw new Error("User not authenticated");let s=new Date;s.setDate(s.getDate()-e);let r=p(d(this.firestore,"dashboardSnapshots"),n("userId","==",t),n("snapshotAt","<",w.fromDate(s))),i=(await h(r)).docs.map(o=>q(o.ref));await Promise.all(i),await this.loadSnapshots()}catch(t){let s=t instanceof Error?t.message:"Failed to delete old snapshots";throw this.error.set(s),t}}getLatestSnapshot(){let e=this.snapshots();return e.length===0?null:e[0]}getSnapshotDaysAgo(e){let t=new Date;return t.setDate(t.getDate()-e),this.snapshots().find(s=>(s.snapshotAt instanceof w?s.snapshotAt.toDate():s.snapshotAt).toDateString()===t.toDateString())||null}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};var ct=class l{http=P(gt);isSending=u(!1);lastError=u(null);async sendWebhook(e,t){if(!e.enabled){console.log("Webhook disabled, skipping notification");return}if(!e.events.includes(t.event)){console.log(`Event ${t.event} not configured for webhook, skipping`);return}if(e.minSeverity==="critical"&&t.severity==="warning"){console.log("Alert severity below threshold, skipping webhook");return}this.isSending.set(!0),this.lastError.set(null);try{let s=this.formatPayload(e.platform,t),r=this.buildHeaders(e);await this.http.post(e.url,s,{headers:r}).toPromise(),console.log("Webhook sent successfully",{url:e.url,event:t.event})}catch(s){let r=s instanceof Error?s.message:"Unknown error";throw this.lastError.set(r),console.error("Failed to send webhook",{error:s,url:e.url}),s}finally{this.isSending.set(!1)}}async sendTestWebhook(e){if(!e.enableTestNotifications)throw new Error("Test notifications are disabled for this webhook");let t={event:"health.warning",severity:"warning",title:"Test Notification",message:"This is a test notification from Hostinger Workspace Manager",workspace:{id:"test-workspace",name:"Test Workspace"},timestamp:new Date().toISOString(),metadata:{healthScore:75}};await this.sendWebhook(e,t)}formatPayload(e,t){switch(e){case"slack":return this.formatSlackPayload(t);case"discord":return this.formatDiscordPayload(t);case"teams":return this.formatTeamsPayload(t);default:return t}}formatSlackPayload(e){let t=e.severity==="critical"?"danger":"warning",s=e.severity==="critical"?":rotating_light:":":warning:",r=[{title:"Workspace",value:e.workspace.name,short:!0},{title:"Severity",value:e.severity.toUpperCase(),short:!0}];return e.metadata&&(e.metadata.healthScore!==void 0&&r.push({title:"Health Score",value:`${e.metadata.healthScore}/100`,short:!0}),e.metadata.rateLimitPercentage!==void 0&&r.push({title:"Rate Limit Usage",value:`${e.metadata.rateLimitPercentage}%`,short:!0}),e.metadata.consecutiveFailures!==void 0&&r.push({title:"Consecutive Failures",value:e.metadata.consecutiveFailures.toString(),short:!0})),{text:`${s} ${e.title}`,attachments:[{color:t,title:e.title,text:e.message,fields:r,footer:"Hostinger Workspace Manager",ts:Math.floor(new Date(e.timestamp).getTime()/1e3)}]}}formatDiscordPayload(e){let t=e.severity==="critical"?16711680:16753920,s=[{name:"Workspace",value:e.workspace.name,inline:!0},{name:"Severity",value:e.severity.toUpperCase(),inline:!0}];return e.metadata&&(e.metadata.healthScore!==void 0&&s.push({name:"Health Score",value:`${e.metadata.healthScore}/100`,inline:!0}),e.metadata.rateLimitPercentage!==void 0&&s.push({name:"Rate Limit Usage",value:`${e.metadata.rateLimitPercentage}%`,inline:!0}),e.metadata.consecutiveFailures!==void 0&&s.push({name:"Consecutive Failures",value:e.metadata.consecutiveFailures.toString(),inline:!0})),{embeds:[{title:e.title,description:e.message,color:t,fields:s,footer:{text:"Hostinger Workspace Manager"},timestamp:e.timestamp}]}}formatTeamsPayload(e){let t=e.severity==="critical"?"FF0000":"FFA500",s=[{name:"Workspace",value:e.workspace.name},{name:"Severity",value:e.severity.toUpperCase()}];return e.metadata&&(e.metadata.healthScore!==void 0&&s.push({name:"Health Score",value:`${e.metadata.healthScore}/100`}),e.metadata.rateLimitPercentage!==void 0&&s.push({name:"Rate Limit Usage",value:`${e.metadata.rateLimitPercentage}%`}),e.metadata.consecutiveFailures!==void 0&&s.push({name:"Consecutive Failures",value:e.metadata.consecutiveFailures.toString()})),{"@type":"MessageCard","@context":"https://schema.org/extensions",themeColor:t,summary:e.title,sections:[{activityTitle:e.title,activitySubtitle:e.message,facts:s}]}}buildHeaders(e){let t=new mt({"Content-Type":"application/json"});return e.headers&&Object.entries(e.headers).forEach(([s,r])=>{t=t.set(s,r)}),e.secret&&(t=t.set("X-Webhook-Secret",e.secret)),t}mapAlertToWebhookEvent(e,t){return e.includes("Rate Limit Critical")?"rateLimit.critical":e.includes("Rate Limit Warning")?"rateLimit.warning":e.includes("Consecutive Failures")||e.includes("Sync Failures")?"sync.consecutiveFailures":e.includes("Circuit Breaker")?"circuitBreaker.open":e.includes("Sync Failed")?"sync.failure":t==="critical"?"health.critical":"health.warning"}static \u0275fac=function(t){return new(t||l)};static \u0275prov=E({token:l,factory:l.\u0275fac,providedIn:"root"})};export{X as a,tt as b,et as c,st as d,rt as e,it as f,at as g,ot as h};
